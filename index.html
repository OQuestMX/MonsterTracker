<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encounter Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .unit-card {
            transition: all 0.3s ease-in-out;
            position: relative;
        }
        .dragging {
            opacity: 0.5;
        }
        .drag-over {
            border-top: 2px solid #10b981; /* emerald-500 */
        }
        @keyframes fadeUpAndOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px);
            }
        }
        .damage-float {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            font-weight: bold;
            pointer-events: none;
            animation: fadeUpAndOut 1s forwards;
        }
        .health-bar-inner {
            transition: background-color 0.5s ease, width 0.3s ease;
        }
        .resizer {
            background: #334155; /* slate-700 */
            cursor: col-resize;
            width: 6px;
            flex-shrink: 0;
            z-index: 10;
        }
        .resizer:hover {
            background: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 p-4">

    <div id="app-container" class="flex flex-col h-screen max-h-screen">
        </div>
    <div id="modal-container"></div>

    <script>
    // --- DATA (SEED MONSTERS & LAIRS) ---
    const SEED_MONSTERS=[
        {id:"grilp-minion-l4",name:"Grilp",level:4,ac:19,organization:"minion",role:"ambusher",ev:6,stamina:8,freeStrike:3,size:"1T",speed:7,keywords:["devil","hobgoblin","infernal"],source:"Monsters PDF p.172",minion:true,minionPerSquad:4,notes:{movement:"Fly",withCaptain:"+2 bonus to speed"},attributes:{might:-1,agility:3,reason:0,intuition:1,presence:0},immunities:["Fire 2"],weaknesses:[],resistances:[],traits:[{name:"Bat Out Of Hell",text:"Any enemy who makes a saving throw takes a −1 penalty to the saving throw for each grilp adjacent to them."},{name:"Shifting Camouflage",text:"The grilp has concealment from all creatures."}],abilities:[{id:"flyby-bite",type:"signature",name:"Flyby Bite 2d10 + 3",action:"main",distance:"melee 1",keywords:["Melee","Strike","Weapon"],text:"One creature or object per minion. Effect: The grilp moves up to their speed and can attempt to hide.",tiers:[{threshold:"≤11",effect:"3 damage"},{threshold:"12–16",effect:"5 damage"},{threshold:"17+",effect:"7 damage; the grilp shifts up to 2 squares"}]}]},
        {id:"hobgoblin-bloodlord-l6",name:"Hobgoblin Bloodlord",level:6,ac:19,organization:"leader",role:"none",ev:32,stamina:180,freeStrike:7,size:"1M",speed:6,keywords:["goblin","hobgoblin","humanoid","infernal"],source:"Monsters PDF p.178–179",notes:{movement:"Teleport"},attributes:{might:4,agility:2,reason:2,intuition:3,presence:3},immunities:["Fire 6"],weaknesses:[],resistances:[],traits:[{name:"Infernal Ichor",text:"When the bloodlord is reduced to 0 Stamina, they spray burning blood. Each creature adjacent to the bloodlord takes 3 fire damage."},{name:"End Effect",text:"At the end of each of their turns, the bloodlord can take 10 damage to end one effect on them that can be ended by a saving throw. This damage can’t be reduced in any way."}],abilities:[{id:"soul-sword",type:"signature",name:"Soul Sword 2d10 + 4",action:"main",distance:"melee 1",keywords:["Magic","Melee","Strike","Weapon"],text:"Two creatures or objects.",malice:2,tiers:[{threshold:"≤11",effect:"11 corruption damage; P<2 bleeding (save ends)"},{threshold:"12–16",effect:"16 corruption damage; P<3 bleeding (save ends)"},{threshold:"17+",effect:"19 corruption damage; P<4 bleeding (save ends)"}]},{id:"soul-sword-mark",type:"action",name:"Soul Sword — Mark",action:"none",keywords:[],text:"Malice rider for Soul Sword: Each target is marked until the end of the encounter or death. Allies gain an edge on strikes against any target marked this way. Up to three marks; applying a new one beyond the limit ends the oldest."},{id:"take-point",type:"maneuver",name:"Take Point!",action:"maneuver",distance:"ranged 10",keywords:["Ranged"],text:"One ally. Effect: The target moves up to their speed and can use a signature ability."},{id:"army-from-blood",type:"triggered",name:"An Army From Blood",action:"triggered",distance:"ranged 10",keywords:["Ranged"],malice:3,trigger:"A non-minion hobgoblin within distance takes damage.",text:"Three hobgoblin recruits manifest from the target’s blood into unoccupied spaces adjacent to the target."}],villainActions:[{name:"Advance!",text:"Shift up to speed; during/after movement use Zweihander Swing twice."},{name:"Back!",text:"Area 5 burst; slide each enemy up to 5 squares."},{name:"I Am Fire! I Am Death! 2d10 + 4",text:"Area 5 burst; Each enemy takes fire damage and is pushed and made prone based on Presence. The bloodlord is wreathed in black flames for the encounter."}]},
        {id:"human-archer-minion-l1",name:"Human Archer (Squad)",level:1,ac:15,organization:"minion",role:"artillery",ev:3,stamina:3,freeStrike:2,size:"1M",speed:5,keywords:["human","humanoid"],source:"Monsters PDF p.181",attributes:{might:0,agility:2,reason:0,intuition:0,presence:0},immunities:["Corruption 1","Psychic 1"],weaknesses:[],resistances:[],notes:{withCaptain:"+5 bonus to ranged distance"},traits:[{name:"Supernatural Insight",text:"The archer ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"crossbow",type:"signature",name:"Crossbow 2d10 + 2",action:"main",distance:"ranged 10",keywords:["Ranged","Strike","Weapon"],text:"One creature or object per minion.",tiers:[{threshold:"≤11",effect:"2 damage"},{threshold:"12-16",effect:"4 damage"},{threshold:"17+",effect:"5 damage"}]}]},
        {id:"human-death-acolyte-minion-l1",name:"Human Death Acolyte (Squad)",level:1,ac:15,organization:"minion",role:"hexer",ev:3,stamina:3,freeStrike:1,size:"1M",speed:5,keywords:["human","humanoid"],source:"Monsters PDF p.181",attributes:{might:0,agility:1,reason:0,intuition:0,presence:2},immunities:["Corruption 1","Psychic 1"],weaknesses:[],resistances:[],notes:{withCaptain:"+5 bonus to ranged distance"},traits:[{name:"Supernatural Insight",text:"The death acolyte ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"necrotic-bolt",type:"signature",name:"Necrotic Bolt 2d10 + 2",action:"main",distance:"ranged 10",keywords:["Ranged","Strike","Weapon"],text:"One creature or object per minion. Effect: One creature within 5 squares regains 1 Stamina.",tiers:[{threshold:"≤11",effect:"1 corruption damage"},{threshold:"12-16",effect:"2 corruption damage"},{threshold:"17+",effect:"3 corruption damage"}]}]},
        {id:"human-apprentice-mage-minion-l2",name:"Human Apprentice Mage (Squad)",level:2,ac:17,organization:"minion",role:"controller",ev:4,stamina:4,freeStrike:2,size:"1M",speed:5,keywords:["human","humanoid"],source:"Monsters PDF p.181",attributes:{might:0,agility:1,reason:0,intuition:0,presence:2},immunities:["Corruption 1","Psychic 1"],weaknesses:[],resistances:[],notes:{withCaptain:"+5 bonus to speed"},traits:[{name:"Supernatural Insight",text:"The apprentice mage ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"lightning-strike",type:"signature",name:"Lightning Strike 2d10 + 2",action:"main",distance:"ranged 10",keywords:["Magic","Ranged","Strike"],text:"One creature or object per minion. Effect: If the apprentice mage doesn’t use a maneuver or a move action this turn, the target is also slowed (EoT).",tiers:[{threshold:"≤11",effect:"2 lightning damage"},{threshold:"12-16",effect:"3 lightning damage"},{threshold:"17+",effect:"5 lightning damage"}]}]},
        {id:"human-guard-minion-l1",name:"Human Guard (Squad)",level:1,ac:15,organization:"minion",role:"brute",ev:3,stamina:5,freeStrike:2,size:"1M",speed:5,keywords:["human","humanoid"],source:"Monsters PDF p.182",attributes:{might:0,agility:2,reason:0,intuition:0,presence:1},immunities:["Corruption 1","Psychic 1"],weaknesses:[],resistances:[],notes:{withCaptain:"Gain an edge on strikes"},traits:[{name:"Supernatural Insight",text:"The guard ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"halberd",type:"signature",name:"Halberd 2d10 + 2",action:"main",distance:"melee 2",keywords:["Melee","Strike","Weapon"],text:"One creature or object per minion. Effect: If the guard is flanked, they can make a free strike against a different adjacent target.",tiers:[{threshold:"≤11",effect:"2 damage"},{threshold:"12-16",effect:"4 damage"},{threshold:"17+",effect:"5 damage"}]}]},
        {id:"human-rogue-minion-l1",name:"Human Rogue (Squad)",level:1,ac:15,organization:"minion",role:"ambusher",ev:3,stamina:4,freeStrike:2,size:"1M",speed:7,keywords:["human","humanoid"],source:"Monsters PDF p.182",attributes:{might:0,agility:2,reason:0,intuition:0,presence:0},immunities:["Corruption 1","Psychic 1"],weaknesses:[],resistances:[],notes:{withCaptain:"Gain an edge on strikes"},traits:[{name:"Supernatural Insight",text:"The rogue ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"concealed-dagger",type:"signature",name:"Concealed Dagger 2d10 + 2",action:"main",distance:"melee 1 or ranged 5",keywords:["Melee","Ranged","Strike","Weapon"],text:"One creature or object per minion. Effect: If disguised or hidden, deals +3 damage.",tiers:[{threshold:"≤11",effect:"1 damage"},{threshold:"12-16",effect:"2 damage"},{threshold:"17+",effect:"3 damage"}]}]},
        {id:"human-raider-minion-l1",name:"Human Raider (Squad)",level:1,ac:15,organization:"minion",role:"harrier",ev:3,stamina:4,freeStrike:1,size:"1M",speed:7,keywords:["human","humanoid"],source:"Monsters PDF p.182",attributes:{might:0,agility:2,reason:0,intuition:0,presence:0},immunities:["Corruption 1","Psychic 1"],weaknesses:[],resistances:[],notes:{withCaptain:"Gain an edge on strikes"},traits:[{name:"Supernatural Insight",text:"The raider ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"handaxes",type:"signature",name:"Handaxes 2d10 + 2",action:"main",distance:"melee 1",keywords:["Charge","Melee","Strike","Weapon"],text:"One creature or object per minion. Effect: If used as part of a charge, make a ranged free strike before the ability.",tiers:[{threshold:"≤11",effect:"1 damage"},{threshold:"12-16",effect:"2 damage"},{threshold:"17+",effect:"3 damage"}]}]},
        {id:"human-brawler-platoon-l1",name:"Human Brawler",level:1,ac:15,organization:"platoon",role:"brute",ev:6,stamina:40,freeStrike:4,size:"1M",speed:5,keywords:["human","humanoid"],source:"Monsters PDF p.182",attributes:{might:2,agility:1,reason:0,intuition:0,presence:0},immunities:["Corruption 2","Psychic 2"],weaknesses:[],resistances:[],traits:[{name:"Shoot the Hostage",text:"Halve damage from any strike while grabbing a size 1S+ creature; the grabbed target takes the remainder."},{name:"Supernatural Insight",text:"The brawler ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"haymaker",type:"signature",name:"Haymaker 2d10 + 2",action:"main",distance:"melee 1",keywords:["Melee","Strike","Weapon"],text:"One creature or object. Effect: If target is already grabbed, +2 damage.",tiers:[{threshold:"≤11",effect:"6 damage"},{threshold:"12-16",effect:"9 damage"},{threshold:"17+",effect:"12 damage; M<2 grabbed and target takes a bane on Escape Grab"}]},{id:"throw",type:"maneuver",name:"Throw",action:"maneuver",distance:"melee 1",keywords:[],text:"One creature grabbed by the brawler. Effect: Push the target up to 5 squares.",malice:1}]},
        {id:"human-scoundrel-platoon-l1",name:"Human Scoundrel",level:1,ac:15,organization:"platoon",role:"ambusher",ev:6,stamina:30,freeStrike:4,size:"1M",speed:5,keywords:["human","humanoid"],source:"Monsters PDF p.183",attributes:{might:0,agility:2,reason:0,intuition:0,presence:1},immunities:["Corruption 1","Psychic 1"],weaknesses:[],resistances:[],traits:[{name:"Supernatural Insight",text:"The scoundrel ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"rapier-and-dagger",type:"signature",name:"Rapier and Dagger 2d10 + 2",action:"main",distance:"melee 1",keywords:["Melee","Strike","Weapon"],text:"One creature or object. 2 Malice: If this ability has an edge/double edge, +2 damage.",tiers:[{threshold:"≤11",effect:"6 damage"},{threshold:"12-16",effect:"9 damage"},{threshold:"17+",effect:"12 damage"}]},{id:"dagger-storm",type:"action",name:"Dagger Storm",action:"main",keywords:[],text:"Use Rapier and Dagger against up to three targets; shift up to 2 squares before or after each strike.",malice:5}]},
        {id:"human-trickshot-platoon-l1",name:"Human Trickshot",level:1,ac:15,organization:"platoon",role:"artillery",ev:6,stamina:20,freeStrike:4,size:"1M",speed:5,keywords:["human","humanoid"],source:"Monsters PDF p.184",attributes:{might:0,agility:2,reason:0,intuition:1,presence:0},immunities:["Corruption 1","Psychic 1"],weaknesses:[],resistances:[],traits:[{name:"Supernatural Insight",text:"The trickshot ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"trick-crossbow",type:"signature",name:"Trick Crossbow 2d10 + 2",action:"main",distance:"melee 1 or ranged 15",keywords:["Melee","Ranged","Strike","Weapon"],text:"One creature or object. Ignores cover and concealment. 3 Malice: targets one additional target.",tiers:[{threshold:"≤11",effect:"6 damage"},{threshold:"12-16",effect:"9 damage"},{threshold:"17+",effect:"12 damage"}]}]},
        {id:"human-blackguard-leader-l1",name:"Human Blackguard",level:1,ac:15,organization:"leader",role:"defender",ev:12,stamina:80,freeStrike:4,size:"1M",speed:5,keywords:["human","humanoid"],source:"Monsters PDF p.184–186",attributes:{might:3,agility:2,reason:2,intuition:0,presence:2},immunities:["Corruption 2","Psychic 2"],weaknesses:[],resistances:[],traits:[{name:"End Effect",text:"At the end of each turn, take 5 damage to end one effect that can be ended by a save (damage can’t be reduced)."},{name:"Supernatural Insight",text:"Ignores concealment granted by a supernatural effect."}],abilities:[{id:"zweihander-swing",type:"signature",name:"Zweihander Swing 2d10 + 2",action:"main",area:"1 burst",keywords:["Area","Weapon"],text:"Each enemy in the area. Effect: One ally within 10 squares can make a free strike. 1 Malice: that ally can use their signature ability instead.",tiers:[{threshold:"≤11",effect:"3 damage; M<1 slowed (save ends)"},{threshold:"12-16",effect:"6 damage; M<2 slowed (save ends)"},{threshold:"17+",effect:"8 damage; M<3 slowed (save ends)"}]},{id:"you-mark",type:"maneuver",name:"You!",action:"maneuver",distance:"ranged 10",keywords:["Ranged"],text:"One enemy. Effect: Target is marked until the start of the blackguard’s next turn; the blackguard and allies gain an edge vs. marked targets."},{id:"parry",type:"triggered",name:"Parry!",action:"triggered",distance:"melee 1",keywords:["Melee"],trigger:"A creature makes a strike against the blackguard or an adjacent ally.",text:"Self or one ally. Effect: Halve the damage."}],villainActions:[{name:"Advance!",text:"Shift up to speed; during/after movement use Zweihander Swing twice."},{name:"Back!",text:"Area 5 burst; slide each enemy up to 5 squares."},{name:"I Can Throw My Blade and So Should You!",text:"Area 3 cube within 5; use Zweihander Swing against each target; each ally within 5 squares of the area can then make a free strike (one target per ally)."}]},
        {id:"orc-godcaller-platoon-l1",name:"Orc Godcaller",level:1,ac:15,organization:"platoon",role:"support",ev:6,stamina:30,freeStrike:3,size:"1M",speed:6,keywords:["humanoid","orc"],source:"User Image",attributes:{might:1,agility:0,reason:0,intuition:1,presence:2},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Relentless",text:"If the godcaller is reduced to 0 Stamina, they can make a free strike before dying. If the target of the free strike is reduced to 0 Stamina, the godcaller is reduced to 1 Stamina instead."}],abilities:[{id:"power-chord",type:"signature",name:"Power Chord 2d10 + 2",action:"main",distance:"melee 1 or ranged 10",keywords:["Magic","Melee","Ranged","Strike"],text:"One creature or object.",tiers:[{threshold:"≤11",effect:"5 sonic damage"},{threshold:"12-16",effect:"7 sonic damage"},{threshold:"17+",effect:"9 sonic damage; P<2 weakened (save ends)"}]},{id:"cadenza",type:"action",name:"Cadenza",action:"main",distance:"ranged 10",keywords:["Magic","Ranged"],text:"One ally. Effect: The target moves up to their speed and can use a main action. 3 Malice: The godcaller targets a second ally.",malice:3},{id:"rallying-ostinato",type:"maneuver",name:"Rallying Ostinato",action:"maneuver",distance:"ranged 10",malice:2,keywords:["Magic","Ranged"],text:"Self and three allies. Effect: Each target regains 15 Stamina and ignores difficult terrain until the end of the encounter."}]},{id:"human-storm-mage-platoon-l3",name:"Human Storm Mage",level:3,ac:19,organization:"platoon",role:"controller",ev:10,stamina:40,freeStrike:5,size:"1M",speed:5,keywords:["human","humanoid"],source:"User Image",attributes:{might:0,agility:0,reason:2,intuition:0,presence:1},immunities:["Corruption 3","Psychic 3"],weaknesses:[],resistances:[],traits:[{name:"Arcane Shield",text:"Any melee ability targeting the storm mage takes a bane. Additionally, whenever the mage takes damage from an adjacent enemy, the enemy takes 2 lightning damage, and if they have R<1 they are pushed up to 2 squares."},{name:"Supernatural Insight",text:"The storm mage ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"lightning-bolt",type:"signature",name:"Lightning Bolt 2d10 + 2",action:"main",distance:"ranged 15",keywords:["Magic","Ranged","Strike"],text:"One creature or object. 5 Malice: The ability loses the Ranged and Strike keywords, takes the Area keyword, and is a 10 x 1 line within 15 that targets each enemy and object in the area.",tiers:[{threshold:"≤11",effect:"7 lightning damage"},{threshold:"12-16",effect:"10 lightning damage"},{threshold:"17+",effect:"13 lightning damage"}]},{id:"gust-of-wind",type:"maneuver",name:"Gust of Wind 2d10 + 2",action:"maneuver",area:"5 cube within 1",malice:3,keywords:["Area","Magic"],text:"Each enemy and object in the area. Effect: The gust of wind disperses gas or vapor and extinguishes any flames, including supernatural effects.",tiers:[{threshold:"≤11",effect:"Slide 2; M<0 slowed (save ends)"},{threshold:"12-16",effect:"Slide 4; M<1 slowed (save ends)"},{threshold:"17+",effect:"Slide 6; M<2 slowed (save ends)"}]}]},{id:"hobgoblin-burning-witch-platoon-l4",name:"Hobgoblin Burning Witch",level:4,ac:19,organization:"platoon",role:"controller",ev:12,stamina:50,freeStrike:5,size:"1M",speed:5,keywords:["goblin","hobgoblin","humanoid","infernal"],source:"User Image",notes:{movement:"Teleport"},attributes:{might:0,agility:1,reason:2,intuition:2,presence:3},immunities:["Fire"],weaknesses:[],resistances:[],traits:[{name:"Infernal Ichor",text:"When the burning witch is reduced to 0 Stamina, they spray burning blood. Each creature adjacent to the burning witch takes 3 fire damage."}],abilities:[{id:"soul-burn",type:"signature",name:"Soul Burn 2d10 + 3",action:"main",distance:"ranged 10",keywords:["Magic","Ranged","Strike"],text:"Two creatures or objects. 2 Malice: Each target who has P<2 is weakened (save ends). Any enemy who starts their turn within 3 squares of a target weakened this way and who has P<2 is weakened (save ends).",malice:2,tiers:[{threshold:"≤11",effect:"4 corruption or fire damage"},{threshold:"12-16",effect:"6 corruption or fire damage"},{threshold:"17+",effect:"8 corruption or fire damage"}]},{id:"burning-legion",type:"maneuver",name:"Burning Legion",action:"maneuver",distance:"ranged 10",malice:1,keywords:["Magic","Ranged"],text:"Three creatures. Effect: Each target can teleport up to 5 squares. Each creature adjacent to a target at their destination takes 3 fire damage."}]},{id:"goblin-spinecleaver-minion-l1",name:"Goblin Spinecleaver (Squad)",level:1,ac:15,organization:"minion",role:"brute",ev:3,stamina:5,freeStrike:2,size:"1S",speed:5,keywords:["goblin","humanoid"],source:"Monsters PDF p.161–162",minion:!0,minionPerSquad:4,notes:{movement:"Climb",withCaptain:"+1 damage bonus to strikes"},attributes:{might:2,agility:0,reason:0,intuition:0,presence:-1},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The spinecleaver doesn’t provoke opportunity attacks by moving."}],abilities:[{id:"axe",type:"signature",name:"Axe 2d10 + 2",action:"main",distance:"melee 1",keywords:["Melee","Strike","Weapon"],text:"One creature or object per minion.",tiers:[{threshold:"≤11",effect:"2 damage; push 1"},{threshold:"12–16",effect:"4 damage; push 3"},{threshold:"17+",effect:"5 damage; push 4"}]}]},{id:"goblin-sniper-minion-l1",name:"Goblin Sniper (Squad)",level:1,ac:15,organization:"minion",role:"artillery",ev:3,stamina:3,freeStrike:2,size:"1S",speed:5,keywords:["goblin","humanoid"],source:"Monsters PDF p.161",minion:!0,minionPerSquad:4,notes:{movement:"Climb",withCaptain:"+5 bonus to ranged distance"},attributes:{might:-2,agility:2,reason:0,intuition:0,presence:-1},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The sniper doesn’t provoke opportunity attacks by moving."}],abilities:[{id:"bow",type:"signature",name:"Bow 2d10 + 2",action:"main",distance:"ranged 10",keywords:["Ranged","Strike","Weapon"],text:"One creature or object per minion. If the sniper doesn’t use a move action this turn, this ability gains an edge.",tiers:[{threshold:"≤11",effect:"2 damage"},{threshold:"12–16",effect:"4 damage"},{threshold:"17+",effect:"5 damage"}]}]},{id:"goblin-assassin-horde-l1",name:"Goblin Assassin",level:1,ac:15,organization:"horde",role:"ambusher",ev:3,stamina:15,freeStrike:2,size:"1S",speed:6,keywords:["goblin","humanoid"],source:"Monsters PDF p.162",notes:{movement:"Climb"},attributes:{might:-2,agility:2,reason:0,intuition:0,presence:-2},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The assassin doesn’t provoke opportunity attacks by moving."},{name:"Slip Away",text:"The assassin can attempt to hide even while observed."}],abilities:[{id:"stab",type:"signature",name:"Sword Stab 2d10 + 2",action:"main",distance:"melee 1",keywords:["Melee","Strike","Weapon"],text:"One creature or object.",tiers:[{threshold:"≤11",effect:"4 damage"},{threshold:"12–16",effect:"6 damage"},{threshold:"17+",effect:"7 damage"}],onHit:"If this ability gains an edge or has a double edge, it deals an extra 2 damage."},{id:"chains",type:"action",name:"Shadow Chains 2d10 + 2",action:"main",distance:"ranged 10",keywords:["Magic","Ranged","Strike"],text:"Three creatures.",malice:3,tiers:[{threshold:"≤11",effect:"2 corruption damage; A<0 restrained (save ends)"},{threshold:"12–16",effect:"4 corruption damage; A<1 restrained (save ends)"},{threshold:"17+",effect:"5 corruption damage; A<2 restrained (save ends)"}]}]},{id:"goblin-cursespitter-horde-l1",name:"Goblin Cursespitter",level:1,ac:15,organization:"horde",role:"hexer",ev:3,stamina:10,freeStrike:1,size:"1S",speed:5,keywords:["goblin","humanoid"],source:"Monsters PDF p.163",notes:{movement:"Climb"},attributes:{might:-2,agility:1,reason:0,intuition:2,presence:0},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The cursespitter doesn’t provoke opportunity attacks by moving."}],abilities:[{id:"eye",type:"signature",name:"Eye of Surlach 2d10 + 2",action:"main",distance:"ranged 15",keywords:["Magic","Ranged","Strike"],text:"One creature.",tiers:[{threshold:"≤11",effect:"3 corruption damage; K<0 weakened (save ends)"},{threshold:"12–16",effect:"4 corruption damage; K<1 weakened (save ends)"},{threshold:"17+",effect:"5 corruption damage; K<2 weakened (save ends)"}]},{id:"hex",type:"maneuver",name:"Dizzying Hex 2d10 + 2",action:"maneuver",distance:"ranged 10",malice:1,keywords:["Magic","Ranged","Strike"],text:"One creature.",tiers:[{threshold:"≤11",effect:"K<0 prone"},{threshold:"12–16",effect:"K<1 prone and can’t stand (EoT)"},{threshold:"17+",effect:"Prone; K<2 can’t stand (save ends)"}]}]},{id:"goblin-warrior-horde-l1",name:"Goblin Warrior",level:1,ac:15,organization:"horde",role:"harrier",ev:3,stamina:15,freeStrike:1,size:"1S",speed:6,keywords:["goblin","humanoid"],source:"Monsters PDF p.164",notes:{movement:"Climb"},attributes:{might:-2,agility:2,reason:0,intuition:0,presence:-1},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The warrior doesn’t provoke opportunity attacks by moving."}],abilities:[{id:"spear",type:"signature",name:"Spear Charge 2d10 + 2",action:"main",distance:"melee 1",keywords:["Charge","Melee","Strike","Weapon"],text:"One creature or object.",tiers:[{threshold:"≤11",effect:"3 damage"},{threshold:"12–16",effect:"4 damage"},{threshold:"17+",effect:"5 damage"}]},{id:"bury",type:"action",name:"Bury the Point 2d10 + 2",action:"main",distance:"melee 1",malice:2,keywords:["Melee","Strike","Weapon"],text:"One creature.",tiers:[{threshold:"≤11",effect:"5 damage; M<0 bleeding (save ends)"},{threshold:"12–16",effect:"6 damage; M<1 bleeding (save ends)"},{threshold:"17+",effect:"7 damage; M<3 bleeding (save ends)"}]}]}];
    
    const SEED_LAIRS = [
        { id: "goblin-cave", name: "Caverna de Goblins", lairActions: [
            { id: "bats", name: "Nube de Murciélagos", desc: "Los héroes en un área de 10 pies deben superar una salvación de CON DC 13 o quedan cegados por un turno." },
            { id: "bridge", name: "Puente desvencijado", desc: "Quienes estén sobre el puente deben hacer una salvación de DEX DC 12 o caer." },
            { id: "rocks", name: "Rocas que caen", desc: "Caen estalactitas sobre un héroe aleatorio (DC 14 salvación de DEX para mitad de daño)." }
        ]},
        { id: "orc-fortress", name: "Fortaleza Orca", lairActions: [
            { id: "trap", name: "Trampa de Foso", desc: "Un héroe aleatorio debe superar una salvación de DEX DC 15 o caer en un foso de 10 pies." },
            { id: "archers", name: "Alerta de Arqueros", desc: "Una lluvia de flechas cae sobre el campo (DC 12 salvación de DEX para mitad de daño)." },
            { id: "oil", name: "Caldero de Aceite", desc: "Se vierte aceite hirviendo en un área de 5 pies (DC 13 salvación de DEX para mitad de daño)." }
        ]}
    ];

    const CONDITIONS_MAP = {
        blinded: "Una criatura cegada no puede ver y falla automáticamente cualquier prueba de habilidad que requiera vista. Las tiradas de ataque contra la criatura tienen ventaja, y las tiradas de ataque de la criatura tienen desventaja.",
        dazed: "Una criatura atontada no puede tomar reacciones y solo puede realizar una acción en su turno: moverse o atacar.",
        grabbed: "Una criatura agarrada tiene su velocidad reducida a 0 y no puede beneficiarse de ningún bonus a su velocidad.",
        poisoned: "Una criatura envenenada tiene desventaja en las tiradas de ataque y en las pruebas de habilidad.",
        prone: "Una criatura derribada solo puede moverse arrastrándose, a menos que se levante. La criatura tiene desventaja en las tiradas de ataque. Una tirada de ataque contra la criatura tiene ventaja si el atacante está a 5 pies de ella, de lo contrario, la tirada tiene desventaja.",
        restrained: "Una criatura inmovilizada tiene su velocidad reducida a 0. Las tiradas de ataque contra ella tienen ventaja, y sus tiradas de ataque y salvación de Destreza tienen desventaja.",
        slowed: "Una criatura ralentizada tiene su velocidad reducida a la mitad y tiene un -2 a su CA y a las tiradas de salvación de Destreza.",
        stunned: "Una criatura aturdida está incapacitada, no puede moverse y solo puede hablar de forma vacilante. Falla automáticamente las tiradas de salvación de Fuerza y Destreza. Las tiradas de ataque en su contra tienen ventaja.",
        weakened: "Una criatura debilitada tiene desventaja en las tiradas de ataque y salvaciones basadas en Fuerza, Destreza o Constitución.",
        hexed: "Maldito: Elige una habilidad. El objetivo tiene desventaja en las pruebas de esa habilidad.",
        hunterMarked: "Marca del Cazador: El atacante sabe la ubicación del objetivo y hace daño extra contra él."
    };
    
    const ROLE_ICONS = {
        ambusher: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mask" viewBox="0 0 16 16" title="Ambusher"><path d="M6.225 1.227A7.5 7.5 0 0 1 10.5 8a7.5 7.5 0 0 1-4.275 6.773 7.003 7.003 0 0 0 2.758-1.017c.52-.39,1.012-.864,1.46-1.405C10.867 11.875 11 11.342 11 10.5c0-.24-.023-.47-.065-.692.16-.147.33-.31.508-.495.18-.188.353-.39.528-.604.177-.217.343-.45.508-.705.164-.25.32-.52.468-.81.148-.29.288-.602.418-.938.13-.337.25-.698.358-1.08.108-.38.203-.78.286-1.2.083-.42.153-.86.208-1.32.055-.46.095-.94.12-1.44.025-.5.038-1.02.038-1.54a.5.5 0 0 0-1 0c0 .52-.013 1.04-.038 1.54-.025.5-.065.98-.12 1.44a8.45 8.45 0 0 1-.208 1.32c-.083.42-.153.82-.286 1.2-.108.382-.203.782-.358 1.08-.13.336-.27.648-.418.938-.148.29-.304.56-.468.81-.165.255-.33.488-.508.705-.176.214-.348.416-.528.604-.18.185-.348.348-.508.495A6.501 6.501 0 0 0 10.5 9a6.5 6.5 0 0 0-4.058 1.44.5.5 0 0 0 .416.862A6.997 6.997 0 0 0 9.5 8a6.997 6.997 0 0 0-2.71-5.582.5.5 0 0 0-.563-.192zM3.283 3.283A6.997 6.997 0 0 0 2.5 8a6.997 6.997 0 0 0 .783 4.717.5.5 0 0 0 .862-.416A6.501 6.501 0 0 1 3.5 8a6.5 6.5 0 0 1 .58-2.854.5.5 0 0 0-.796-.563z"/></svg>`,
        artillery: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bullseye" viewBox="0 0 16 16" title="Artillery"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 13A5 5 0 1 1 8 3a5 5 0 0 1 0 10zm0 1A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/><path d="M9.5 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg>`,
        brute: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-hammer" viewBox="0 0 16 16" title="Brute"><path d="M9.972 2.508a.5.5 0 0 0-.16-.556l-.178-.129a5.009 5.009 0 0 0-2.076-.783C6.215.862 4.504 1.229 2.84 3.133H1.786a.5.5 0 0 0-.354.147L.146 4.567a.5.5 0 0 0 0 .706l2.571 2.579a.5.5 0 0 0 .708 0l1.286-1.29a.5.5 0 0 0 .146-.353V5.57l8.387 8.873A.5.5 0 0 0 14 14.5l1.5-1.5a.5.5 0 0 0 0-.707l-8.387-8.873h.582a.5.5 0 0 0 .353-.147l1.29-1.286a.5.5 0 0 0-.146-.353l-1.765-1.766z"/></svg>`,
        controller: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tornado" viewBox="0 0 16 16" title="Controller"><path d="M3.734 1.002a.5.5 0 0 1 .491.592l-1.2 4.2a.5.5 0 0 1-.982 0l1.2-4.2a.5.5 0 0 1 .491-.592zM5.396 2.002a.5.5 0 0 1 .49.592l-1.2 4.2a.5.5 0 0 1-.98 0l1.2-4.2a.5.5 0 0 1 .49-.592zM7.058 3.002a.5.5 0 0 1 .49.592l-1.2 4.2a.5.5 0 0 1-.98 0l1.2-4.2a.5.5 0 0 1 .49-.592zM8.72 4.002a.5.5 0 0 1 .49.592l-1.2 4.2a.5.5 0 0 1-.98 0l1.2-4.2a.5.5 0 0 1 .49-.592zM10.382 5.002a.5.5 0 0 1 .49.592l-1.2 4.2a.5.5 0 0 1-.98 0l1.2-4.2a.5.5 0 0 1 .49-.592zM12.044 6.002a.5.5 0 0 1 .49.592l-1.2 4.2a.5.5 0 0 1-.98 0l1.2-4.2a.5.5 0 0 1 .49-.592zM2.5 12a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5zM4.5 12a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5zM6.5 12a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5zM8.5 12a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5zM10.5 12a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5zM12.5 12a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5z"/></svg>`,
        defender: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-fill" viewBox="0 0 16 16" title="Defender"><path d="M5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887 1.177C14.254 2.18 15 2.934 15 3.72V8.5c0 2.756-3.5 4.5-5 5.5-1.5-1-5-2.744-5-5.5V3.72c0-.786.746-1.54 1.113-1.983C1.843 1.215 2.96 .865 4.072.56z"/></svg>`,
        harrier: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-wind" viewBox="0 0 16 16" title="Harrier"><path d="M12.5 2A2.5 2.5 0 0 0 10 4.5a.5.5 0 0 1-1 0A3.5 3.5 0 1 1 12.5 8H.5a.5.5 0 0 1 0-1h12a2.5 2.5 0 0 0 0-5zm-7 1a1 1 0 0 0-1 1 .5.5 0 0 1-1 0 2 2 0 1 1 2 2h-5a.5.5 0 0 1 0-1h5a1 1 0 0 0 0-2zM0 8a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 0 8zm2.5 4a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5z"/></svg>`,
        hexer: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-magic" viewBox="0 0 16 16" title="Hexer"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4L8 3.293a.5.5 0 0 0-.707-.707L6.586 3.293a.5.5 0 0 0 .707.707Zm-.217 8.243c.28-.28.22-.76-.09-1.03l-1.8-1.8a.695.695 0 0 0-1.03-.09c-.28.28-.22.76.09 1.03l1.8 1.8c.27.27.75.33 1.03.09Zm-3.12-3.12a.695.695 0 0 0-1.03-.09l-1.8 1.8c-.28.28-.22.76.09 1.03l.09.09a.695.695 0 0 0 1.03-.09l1.8-1.8c.27-.27.33-.75.09-1.03Zm2.42-2.42a.695.695 0 0 0-1.03-.09l-1.8 1.8c-.28.28-.22.76.09 1.03l.09.09a.695.695 0 0 0 1.03-.09l1.8-1.8c.27-.27.33-.75.09-1.03Zm2.42-2.42a.695.695 0 0 0-1.03-.09l-1.8 1.8c-.28.28-.22.76.09 1.03l.09.09a.695.695 0 0 0 1.03-.09l1.8-1.8c.27-.27.33-.75.09-1.03Zm-3.12-3.12a.695.695 0 0 0-1.03-.09l-1.8 1.8c-.28.28-.22.76.09 1.03l.09.09a.695.695 0 0 0 1.03-.09l1.8-1.8c.27-.27.33-.75.09-1.03a.5.5 0 1 0-1 0v1.293a.5.5 0 0 0 .707.707L3.414 11l-2.121 2.121a.5.5 0 0 0 .707.707L4.121 11.707a.5.5 0 0 0 .707-.707L2.707 9H4.12a.5.5 0 1 0 0-1H2.707l2.122-2.121a.5.5 0 0 0-.707-.707L2 7.121V5.707a.5.5 0 0 0-1 0v1.414l-2.121 2.121a.5.5 0 0 0 .707.707L1.707 8.414a.5.5 0 0 0 .707-.707L.293 5.586a.5.5 0 0 0 0 .707l2.121 2.121V8a.5.5 0 0 0 1 0V6.586l2.121-2.121a.5.5 0 0 0-.707-.707L5.586 5.879a.5.5 0 0 0-.707.707L6 8.707l-1.707 1.707a.5.5 0 0 0 .707.707L6.293 9.414a.5.5 0 0 0 .707-.707L5.293 7a.5.5 0 0 0-.707-.707l-1.707 1.707a.5.5 0 0 0 .707.707L5.707 8.121a.5.5 0 0 0 .707-.707L4.293 5.293a.5.5 0 0 0-.707.707L5.707 8.121z"/></svg>`,
        support: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16" title="Support"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>`,
    };

    // --- STATE MANAGEMENT ---
    const LS_KEY = "ds_encounter_html_v5";
    let state = {};

   function initState() {
        const defaultState = {
            isLibraryOpen: true,
            isInitiativeOpen: true,
            builder: [],
            savedScenes: [],
            tracker: null,
            party: { teamName: "Aventureros", director: "Director del Juego" },
            filters: { keywords: [], organizations: [], levels: [], q: '' },
            openMonsterCards: {},
            openUnitCards: {},
            activeUnitTabs: {},
            selectedUnitId: null,
            isHeroModalOpen: false,
            conditionDropdownOpen: null,
            panelWidths: {
                library: '33.33%',
                initiative: '33.33%'
            },
            selectedLairId: null,
            collapsedRaceGroups: [],
            isFiltersOpen: true,
        };
        try {
            const loadedState = JSON.parse(localStorage.getItem(LS_KEY));
            state = { ...defaultState, ...(loadedState || {}) };
            
            // --- INICIO DE LA SOLUCIÓN DEFINITIVA ---

            // 1. Asegura que savedScenes siempre sea un arreglo válido.
            if (!Array.isArray(state.savedScenes)) { 
                state.savedScenes = [];
            }

            // 2. Asegura que 'filters' y sus propiedades internas siempre tengan la estructura correcta.
            // Esto fusiona los filtros por defecto con cualquier filtro que se haya cargado,
            // garantizando que 'keywords', 'organizations', etc., siempre existan como arreglos.
            state.filters = { ...defaultState.filters, ...(state.filters || {}) };

            // --- FIN DE LA SOLUCIÓN DEFINITIVA ---

        } catch (e) {
            console.error("Failed to load state, using defaults:", e);
            state = defaultState;
        }
    }

    function saveState() {
        try {
            const stateToSave = { ...state, openMonsterCards: {}, openUnitCards: {}, activeUnitTabs: {} };
            localStorage.setItem(LS_KEY, JSON.stringify(stateToSave));
        } catch (e) {
            console.error("Failed to save state:", e);
        }
    }
    
    // --- HELPERS ---
    function fmtMod(n) { return n > 0 ? `+${n}` : String(n); }
    function cryptoRandom() {
        if (typeof crypto !== "undefined" && crypto.getRandomValues) {
            const a = new Uint32Array(1); crypto.getRandomValues(a); return a[0].toString(36);
        }
        return Math.random().toString(36).slice(2);
    }
    function getMonsterById(id) {
        return SEED_MONSTERS.find(m => m.id === id);
    }
    function getLairById(id) {
        return SEED_LAIRS.find(l => l.id === id);
    }
    function toggleInArray(arr, val) {
        return arr.includes(val) ? arr.filter(v => v !== val) : [...arr, val];
    }
    function getHealthColor(percentage) {
        const p = percentage / 100;
        const r = p > 0.5 ? 255 - 255 * (p - 0.5) * 2 : 255;
        const g = p < 0.5 ? 255 * p * 2 : 255;
        return `rgb(${Math.round(r)}, ${Math.round(g)}, 0)`;
    }

    // --- RENDER FUNCTIONS ---
    const appContainer = document.getElementById('app-container');
    const modalContainer = document.getElementById('modal-container');

    function render() {
        const { isLibraryOpen, isInitiativeOpen, tracker, party, isHeroModalOpen, panelWidths } = state;
        
        const libraryStyle = isLibraryOpen ? `width: ${panelWidths.library};` : 'width: auto;';
        const initiativeStyle = isInitiativeOpen ? `width: ${panelWidths.initiative};` : 'width: auto;';

        appContainer.innerHTML = `
            <header class="flex-shrink-0">
                ${tracker ? renderTrackerHeader(party, tracker) : ''}
            </header>

            <main class="flex-grow flex gap-0 overflow-hidden">
                <div id="library-container" style="${libraryStyle}" class="transition-all duration-300 flex-shrink-0 min-h-0">
                    ${renderLibraryPanel()}
                </div>
                <div id="library-resizer" class="resizer" data-panel="library"></div>

                <div id="main-container" class="flex-grow flex flex-col space-y-4 overflow-auto custom-scrollbar min-h-0 px-4">
                    ${!tracker ? renderBuilderPanel() : ''}
                    ${tracker ? renderTrackerPanel() : ''}
                </div>
                
                <div id="initiative-resizer" class="resizer" data-panel="initiative"></div>
                <div id="initiative-container" style="${initiativeStyle}" class="transition-all duration-300 flex-shrink-0 min-h-0">
                    ${tracker ? renderInitiativePanel() : ''}
                </div>
            </main>
        `;
        
        modalContainer.innerHTML = isHeroModalOpen ? renderHeroModal() : '';
        addEventListeners();
    }

    function renderTrackerHeader(party, tracker) {
        return `
            <div class="bg-slate-900 border border-slate-800 rounded-2xl p-3 mb-4 flex justify-between items-center">
                <div class="flex items-center gap-4 text-sm">
                    <div>
                        <span class="opacity-70">Equipo: </span>
                        <input type="text" data-party-field="teamName" value="${party.teamName}" class="bg-slate-800 rounded px-2 py-1 w-40"/>
                    </div>
                    <div>
                        <span class="opacity-70">Director: </span>
                        <input type="text" data-party-field="director" value="${party.director}" class="bg-slate-800 rounded px-2 py-1 w-40"/>
                    </div>
                </div>
                <div class="flex items-center gap-6 text-right">
                    <div>
                        <div class="text-xs opacity-70">Ronda</div>
                        <div class="text-lg font-semibold">${tracker.round}</div>
                    </div>
                    <div>
                        <div class="text-xs opacity-70">Turno</div>
                        <div class="text-lg font-semibold">${tracker.order.length > 0 ? tracker.turnIndex + 1 : 0}/${tracker.order.length}</div>
                    </div>
                    <div>
                        <div class="text-xs opacity-70">Unidades</div>
                        <div class="text-lg font-semibold">${tracker.units.length}</div>
                    </div>
                    <div>
                        <div class="text-xs opacity-70">Malice</div>
                        <div class="text-2xl font-bold text-violet-400">${tracker.malice}</div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderLibraryPanel() {
        const { filters, isLibraryOpen, collapsedRaceGroups, isFiltersOpen } = state;
        const filterOptions = (() => {
            const keywords = [...new Set(SEED_MONSTERS.flatMap(m => m.keywords.filter(k => k !== 'humanoid')))].sort();
            const organizations = [...new Set(SEED_MONSTERS.map(m => m.organization))].sort();
            const levels = [...new Set(SEED_MONSTERS.map(m => m.level))].sort((a,b) => a - b);
            return { keywords, organizations, levels };
        })();

        const filteredMonsters = SEED_MONSTERS.filter(m => {
            const nameMatch = filters.q === "" || m.name.toLowerCase().includes(filters.q.toLowerCase());
            const keywordMatch = filters.keywords.length === 0 || m.keywords.some(k => filters.keywords.includes(k));
            const orgMatch = filters.organizations.length === 0 || filters.organizations.includes(m.organization);
            const levelMatch = filters.levels.length === 0 || filters.levels.includes(m.level.toString());
            return nameMatch && keywordMatch && orgMatch && levelMatch;
        });

        const groupedByRace = filteredMonsters.reduce((acc, m) => {
            const race = m.keywords.find(k => k === 'hobgoblin') || m.keywords.find(k => k !== 'humanoid') || 'other';
            if (!acc[race]) acc[race] = [];
            acc[race].push(m);
            return acc;
        }, {});

        return `
            <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-2 h-full flex flex-col">
                <div class="flex justify-between items-center">
                    <div class="font-medium ${!isLibraryOpen ? 'hidden' : ''}">Biblioteca</div>
                    <button data-action="toggle-library" class="px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs">
                        ${isLibraryOpen ? '<<' : '>>'}
                    </button>
                </div>
                <div class="${!isLibraryOpen ? 'hidden' : ''}">
                    <input id="search-input" class="w-full bg-slate-800 rounded-lg px-2 py-1 text-sm" placeholder="Buscar por nombre..." value="${filters.q}" />
                    
                    <div class="text-xs mt-2 space-y-2">
                        <div data-action="toggle-filters" class="font-bold cursor-pointer">Filtros ${isFiltersOpen ? '▼' : '►'}</div>
                        <div class="${isFiltersOpen ? '' : 'hidden'}">
                            <div>
                                <div class="font-bold">Raza</div>
                                <div class="flex flex-wrap gap-2 mt-1">${filterOptions.keywords.map(k => `<label class="flex items-center gap-1"><input type="checkbox" data-filter="keywords" value="${k}" ${filters.keywords.includes(k) ? 'checked' : ''}>${k}</label>`).join('')}</div>
                            </div>
                            <div>
                                <div class="font-bold">Organización</div>
                                <div class="flex flex-wrap gap-2 mt-1">${filterOptions.organizations.map(o => `<label class="flex items-center gap-1"><input type="checkbox" data-filter="organizations" value="${o}" ${filters.organizations.includes(o) ? 'checked' : ''}>${o}</label>`).join('')}</div>
                            </div>
                            <div>
                                <div class="font-bold">Nivel</div>
                                <div class="flex flex-wrap gap-2 mt-1">${filterOptions.levels.map(l => `<label class="flex items-center gap-1"><input type="checkbox" data-filter="levels" value="${l}" ${filters.levels.includes(l.toString()) ? 'checked' : ''}>${l}</label>`).join('')}</div>
                            </div>
                            <button data-action="reset-filters" class="w-full text-center py-1 mt-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs">Limpiar filtros</button>
                        </div>
                    </div>
                </div>

                <div class="flex-grow overflow-auto mt-2 custom-scrollbar pr-2 ${!isLibraryOpen ? 'hidden' : ''}">
                    ${Object.keys(groupedByRace).sort().map(race => `
                        <div class="py-1">
                            <h3 data-action="toggle-race-group" data-race="${race}" class="cursor-pointer text-lg font-bold text-slate-400 sticky top-0 bg-slate-900 py-1">${race.charAt(0).toUpperCase() + race.slice(1)}</h3>
                            <div class="${collapsedRaceGroups.includes(race) ? 'hidden' : ''}">
                                ${groupedByRace[race].sort((a,b) => a.name.localeCompare(b.name)).map(m => renderMonsterCard(m)).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderMonsterCard(m) {
        const isOpen = state.openMonsterCards[m.id];
        return `
            <div class="py-2 pl-4 border-l border-slate-800">
                <div class="flex items-center justify-between">
                    <div data-action="toggle-monster-card" data-monster-id="${m.id}" class="cursor-pointer flex-grow pr-4">
                        <div class="text-sm font-medium">${m.name}</div>
                        <div class="text-xs opacity-70 flex items-center gap-1.5">
                            <span>L${m.level}</span> ·
                            <span>${m.organization}</span> ·
                            <span class="flex items-center gap-1">${ROLE_ICONS[m.role] || ''} ${m.role}</span> ·
                            <span>EV ${m.ev}</span> ·
                            <span>FS ${m.freeStrike}</span>
                        </div>
                        <div class="text-[10px] opacity-60">${m.size} · Speed ${m.speed} · ${m.source}</div>
                    </div>
                    <button data-action="add-monster" data-monster-id="${m.id}" class="px-2 py-1 bg-slate-800 rounded-lg hover:bg-slate-700 text-xs flex-shrink-0">Add</button>
                </div>
                ${isOpen ? `
                    <div class="mt-2 text-xs bg-slate-900/60 border border-slate-800 rounded-lg p-2 space-y-2">
                        ${m.notes ? `<div class="flex gap-4">${m.notes.movement ? `<div><div class="opacity-70">Movement</div><div>${m.notes.movement}</div></div>` : ''}${m.notes.withCaptain ? `<div><div class="opacity-70">With Captain</div><div>${m.notes.withCaptain}</div></div>` : ''}</div>` : ''}
                        ${m.attributes ? `<div><div class="font-medium mb-1">Attributes</div><div>Might ${fmtMod(m.attributes.might)} · Agility ${fmtMod(m.attributes.agility)} · Reason ${fmtMod(m.attributes.reason)} · Intuition ${fmtMod(m.attributes.intuition)} · Presence ${fmtMod(m.attributes.presence)}</div></div>` : ''}
                        ${m.traits?.length ? `<div><div class="font-medium mb-1">Traits</div><ul class="list-disc ml-4">${m.traits.map(t => `<li><b>${t.name}.</b> ${t.text}</li>`).join('')}</ul></div>` : ''}
                        ${m.abilities?.length ? `<div><div class="font-medium mb-1">Abilities</div><div class="space-y-2">${m.abilities.map(a => renderAbilityBlock(a)).join('')}</div></div>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }

    function renderAbilityBlock(ability, isTracker = false, unitId = null) {
        const canAfford = isTracker && ability.malice ? state.tracker.malice >= ability.malice : true;
        const clickableClass = isTracker && canAfford ? 'border-slate-800 hover:border-slate-600 cursor-pointer' : 'border-slate-800';
        return `
            <div data-action="${isTracker ? 'use-ability' : ''}" data-ability-id="${ability.id}" ${isTracker ? `data-unit-id="${unitId}"` : ''} class="p-2 rounded border ${clickableClass} ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}">
                <div class="flex items-center justify-between">
                    <div class="font-medium">${ability.name} ${ability.type === 'signature' ? `<span class="opacity-60">(Signature)</span>` : ''}</div>
                    <div class="opacity-70">${ability.action}</div>
                </div>
                <div class="opacity-80">${ability.distance || ''}${ability.area ? ` · ${ability.area}` : ''}${ability.keywords?.length ? ` · ${ability.keywords.join(', ')}` : ''}${ability.malice ? `<span class="font-bold text-violet-400"> · Malice ${ability.malice}</span>` : ''}${ability.usage ? ` · ${ability.usage}` : ''}</div>
                ${ability.tiers?.length ? `<div class="mt-1">${ability.tiers.map(t => `<div>${t.threshold}: ${t.effect}</div>`).join('')}</div>` : ''}
                ${ability.onHit ? `<div>On Hit: ${ability.onHit}</div>` : ''}
                ${ability.text ? `<div>${ability.text}</div>` : ''}
                ${ability.trigger ? `<div>Trigger: ${ability.trigger}</div>` : ''}
            </div>
        `;
    }

    function renderBuilderPanel() {
        const { builder, savedScenes } = state;
        const totalEV = builder.reduce((acc, p) => {
            const m = getMonsterById(p.monsterId);
            if (!m) return acc;
            if (m.organization === 'minion') return acc + m.ev;
            return acc + m.ev * (p.count || 1);
        }, 0);
        const totalUnits = builder.reduce((acc, p) => acc + (getMonsterById(p.monsterId)?.organization === 'minion' ? 1 : (p.count || 1)), 0);

        return `
            <div class="space-y-4">
                <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="font-medium">Creador de Encuentros</div>
                        <div class="flex gap-2">
                            <button data-action="start-encounter" class="px-3 py-1.5 rounded-xl bg-emerald-700 hover:bg-emerald-600 disabled:opacity-40" ${builder.length === 0 ? 'disabled' : ''}>Iniciar Encuentro</button>
                            <button data-action="save-scene" class="px-3 py-1.5 rounded-xl bg-sky-700 hover:bg-sky-600 disabled:opacity-40" ${builder.length === 0 ? 'disabled' : ''}>Guardar Escena</button>
                            <button data-action="reset-builder" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700">Limpiar</button>

                        </div>
                    </div>
                    <div>
                        <input id="scene-name-input" class="w-full bg-slate-800 rounded-lg px-2 py-1 text-sm" placeholder="Nombre de la Escena..." />
                    </div>
                    <div class="text-sm">
                        <label for="lair-select" class="opacity-70">Entorno:</label>
                        <select id="lair-select" data-action="select-lair" class="w-full bg-slate-800 rounded-lg px-2 py-1 mt-1">
                            <option value="none">Ninguno</option>
                            ${SEED_LAIRS.map(l => `<option value="${l.id}" ${state.selectedLairId === l.id ? 'selected' : ''}>${l.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="rounded-xl bg-slate-900/70 border border-slate-800 p-3"><div class="text-xs opacity-70">Total EV</div><div class="text-lg font-semibold">${totalEV}</div></div>
                        <div class="rounded-xl bg-slate-900/70 border border-slate-800 p-3"><div class="text-xs opacity-70"># Unidades</div><div class="text-lg font-semibold">${totalUnits}</div></div>
                    </div>
                    <div class="space-y-2">
                        ${builder.length === 0 ? `<div class="text-sm opacity-70">Añade monstruos desde la biblioteca y pulsa <b>Iniciar Encuentro</b>.</div>` : builder.map(p => renderPlacedMonster(p)).join('')}
                    </div>
                </div>

                <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-3">
                    <div class="font-medium">Aventura - Escenas Guardadas</div>
                    <div class="space-y-2">
                        ${savedScenes.length === 0 ? `<div class="text-sm opacity-70">No hay escenas guardadas.</div>` : savedScenes.map(s => renderSavedScene(s)).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderSavedScene(scene) {
        const totalEV = scene.monsters.reduce((acc, p) => {
            const m = getMonsterById(p.monsterId);
            if (!m) return acc;
            if (m.organization === 'minion') return acc + m.ev;
            return acc + m.ev * (p.count || 1);
        }, 0);
        const totalUnits = scene.monsters.reduce((acc, p) => acc + (getMonsterById(p.monsterId)?.organization === 'minion' ? 1 : (p.count || 1)), 0);

        return `
            <div class="p-3 rounded-xl border border-slate-800 bg-slate-900/60 flex items-center justify-between">
                <div>
                    <div class="font-medium">${scene.name}</div>
                    <div class="text-xs opacity-70">EV: ${totalEV} · Unidades: ${totalUnits} · Entorno: ${scene.lairId ? getLairById(scene.lairId).name : 'Ninguno'}</div>
                </div>
                <div class="flex gap-2">
                    <button data-action="activate-scene" data-scene-id="${scene.id}" class="px-3 py-1.5 rounded-xl bg-emerald-700 hover:bg-emerald-600 text-xs">Activar</button>
                    <button data-action="delete-scene" data-scene-id="${scene.id}" class="px-3 py-1.5 rounded-xl bg-rose-800 hover:bg-rose-700 text-xs">Borrar</button>
                </div>
            </div>
        `;
    }
    
    function renderPlacedMonster(p) {
        const m = getMonsterById(p.monsterId);
        if (!m) return '';
        const countLabel = m.organization === 'minion' ? 'Minions' : 'Copias';
        return `
            <div class="p-3 rounded-xl border border-slate-800 bg-slate-900/60">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium">${m.name}</div>
                        <div class="text-xs opacity-70">L${m.level} · ${m.organization} · ${m.role} · EV ${m.ev} · FS ${m.freeStrike}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1 text-xs">
                            <span>${countLabel}</span>
                            <input type="number" min="1" max="32" data-action="set-placed-count" data-instance-id="${p.instanceId}" class="w-16 bg-slate-800 rounded px-2 py-1" value="${p.count}">
                        </div>
                        <button data-action="remove-placed" data-instance-id="${p.instanceId}" class="px-2 py-1 bg-slate-800 rounded-lg hover:bg-slate-700 text-xs">Quitar</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderTrackerPanel() {
        const { tracker } = state;
        if (!tracker) return '';
        
        const activeUnitIds = tracker.order.slice(tracker.turnIndex);
        const inactiveUnitIds = tracker.order.slice(0, tracker.turnIndex);

        const activeUnits = activeUnitIds.map(id => tracker.units.find(u => u.unitId === id));
        const inactiveUnits = inactiveUnitIds.map(id => tracker.units.find(u => u.unitId === id));

        return `
            <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-3 h-full flex flex-col">
                <div class="flex items-center justify-between flex-shrink-0">
                    <div class="font-medium">Rastreador</div>
                    <div class="flex gap-2">
                         <button data-action="open-hero-modal" class="px-3 py-1.5 rounded-xl bg-blue-700 hover:bg-blue-600">Agregar Héroes</button>
                         <button data-action="end-encounter" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700">Terminar</button>
                    </div>
                </div>
                <div id="tracker-list" class="flex-grow overflow-auto custom-scrollbar pr-1">
                    <div class="text-lg font-bold text-emerald-400">Activos</div>
                    <div class="space-y-2">
                        ${activeUnits.map((u, idx) => renderUnitRow(u, idx === 0)).join('')}
                    </div>
                    
                    ${inactiveUnits.length > 0 ? `<div class="text-lg font-bold text-slate-500 pt-4">Inactivos</div>` : ''}
                    <div class="space-y-2">
                        ${inactiveUnits.map(u => renderUnitRow(u, false)).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderInitiativePanel() {
        const { tracker, isInitiativeOpen } = state;
        if (!tracker) return '';
        
        const livingUnitIds = tracker.order.filter(id => {
            const unit = tracker.units.find(u => u.unitId === id);
            return !unit || unit.role === 'hero' || unit.role === 'lair' || unit.hp > 0;
        });
        const deadUnitIds = tracker.order.filter(id => {
            const unit = tracker.units.find(u => u.unitId === id);
            return unit && unit.role !== 'hero' && unit.role !== 'lair' && unit.hp <= 0;
        });
        const displayOrder = [...livingUnitIds, ...deadUnitIds];

        return `
            <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-2 h-full flex flex-col">
                <div class="flex justify-between items-center">
                    <div class="font-medium ${!isInitiativeOpen ? 'hidden' : ''}">Iniciativa</div>
                    <button data-action="toggle-initiative" class="px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs">
                        ${isInitiativeOpen ? '>>' : '<<'}
                    </button>
                </div>
                <div id="initiative-list" class="flex-grow overflow-auto custom-scrollbar pr-2 ${!isInitiativeOpen ? 'hidden' : ''}">
                    ${displayOrder.map((id) => {
                        const unit = tracker.units.find(u => u.unitId === id);
                        const originalIdx = tracker.order.indexOf(id);
                        const isHero = unit.role === 'hero';
                        const isLair = unit.role === 'lair';
                        const isActive = originalIdx === tracker.turnIndex;
                        const isDead = !isHero && !isLair && unit.hp <= 0;
                        const monster = isHero || isLair ? null : getMonsterById(unit.monsterId);
                        const hasManeuver = !isHero && !isLair && monster?.abilities?.some(a => a.action === 'maneuver');
                        let allActionsUsed = false;
                        if (isHero) {
                            allActionsUsed = unit.actionsUsed.move && unit.actionsUsed.attack1 && unit.actionsUsed.bonusAction;
                        } else if (!isLair) {
                            const attacksDone = unit.maxAttacks > 1 ? (unit.actionsUsed.attack1 && unit.actionsUsed.attack2) : unit.actionsUsed.attack1;
                            allActionsUsed = unit.actionsUsed.move && attacksDone && (!hasManeuver || unit.actionsUsed.maneuver);
                        }
                        
                        let itemStyle = '';
                        let itemClass = 'p-2 my-1 rounded-lg text-xs flex items-center justify-between gap-1 cursor-grab';

                        if (isHero) {
                            itemClass += ' bg-blue-900/50';
                        } else if (isLair) {
                            itemClass += ' bg-violet-900/50';
                        } else if (isDead) {
                            itemClass += ' bg-black/50 filter grayscale';
                            itemStyle = `border: 2px solid #404040;`;
                        } else {
                            const pct = Math.max(0, Math.min(100, Math.round((unit.hp / unit.hpMax) * 100)));
                            const healthColor = getHealthColor(pct);
                            itemClass += ' bg-slate-800';
                            itemStyle = `border: 2px solid ${healthColor};`;
                        }

                        if (isActive) {
                            itemClass += ' ring-2 ring-emerald-500';
                        }
                        if (allActionsUsed && !isDead) {
                            itemClass += ' filter grayscale';
                        }

                        return `
                        <div draggable="true" data-action="select-unit-from-initiative" data-unit-id="${id}" style="${itemStyle}" class="${itemClass}">
                            <span class="truncate"><b>${originalIdx + 1}.</b> ${unit?.name || id}</span>
                        </div>
                    `}).join('')}
                </div>
                 <textarea id="notes-textarea" class="w-full bg-slate-800 rounded-lg p-2 text-sm mt-4 flex-shrink-0 ${!isInitiativeOpen ? 'hidden' : ''}" placeholder="Notas rápidas del encuentro...">${tracker.notes || ''}</textarea>
            </div>
        `;
    }

    function renderUnitRow(u, isActive) {
        if (!u) return '';
        const isHero = u.role === 'hero';
        const isLair = u.role === 'lair';
        const monster = isHero || isLair ? null : getMonsterById(u.monsterId);
        const hasManeuver = !isHero && !isLair && monster?.abilities?.some(a => a.action === 'maneuver');
        const isDead = !isHero && !isLair && u.hp <= 0;
        const isBlooded = !isHero && !isLair && !isDead && u.hp <= u.hpMax * 0.25;
        const isSelected = state.selectedUnitId === u.unitId;
        const pct = isHero || isLair ? 100 : Math.max(0, Math.min(100, Math.round((u.hp / u.hpMax) * 100)));
        const healthColor = getHealthColor(pct);
        const isOpen = state.openUnitCards[u.unitId];
        const activeTab = state.activeUnitTabs[u.unitId] || 'acciones';
        
        let allActionsUsed = false;
        if (isHero) {
            allActionsUsed = u.actionsUsed.move && u.actionsUsed.attack1 && u.actionsUsed.bonusAction;
        } else if (isLair) {
            allActionsUsed = Object.values(u.actionsUsed).some(used => used);
        } else {
            const attacksDone = u.maxAttacks > 1 ? (u.actionsUsed.attack1 && u.actionsUsed.attack2) : u.actionsUsed.attack1;
            allActionsUsed = u.actionsUsed.move && attacksDone && (!hasManeuver || u.actionsUsed.maneuver);
        }

        let borderColor = "border-slate-800";
        if (isActive && !isDead) borderColor = "border-emerald-500 shadow-lg shadow-emerald-500/20";
        else if (isSelected && !isDead) borderColor = "border-blue-500 shadow-lg shadow-blue-500/20";
        if (isLair) borderColor = "border-violet-500";

        const tabButton = (tabName, label) => `<button data-action="set-unit-tab" data-unit-id="${u.unitId}" data-tab-name="${tabName}" class="px-3 py-1 text-xs rounded-t-lg ${activeTab === tabName ? 'bg-slate-800' : 'bg-slate-900'}">${label}</button>`;
        
        const conditionIcons = u.conditions.map(c => `<span class="text-xs bg-red-800 px-1.5 py-0.5 rounded-md" title="${CONDITIONS_MAP[c] || c}">${c.substring(0,3)}</span>`).join('');

        if (isLair) {
            const lair = getLairById(u.lairId);
            return `
                <div id="unit-${u.unitId}" class="unit-card p-3 rounded-xl border ${borderColor} ${allActionsUsed ? 'filter grayscale opacity-60' : 'bg-slate-900/60'}">
                    <div class="font-medium text-sm flex items-center gap-2">
                        <span>${u.name}</span>
                        <span class="opacity-60 text-xs">${u.label}</span>
                    </div>
                    <div class="mt-2 text-xs space-y-2">
                        ${lair.lairActions.map(action => `
                            <div data-action="use-lair-action" data-unit-id="${u.unitId}" data-lair-action-id="${action.id}" class="p-2 rounded border border-slate-800 hover:border-slate-600 cursor-pointer ${u.actionsUsed[action.id] ? 'filter grayscale opacity-50' : ''}">
                                <b>${action.name}:</b> ${action.desc}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        return `
            <div id="unit-${u.unitId}" class="unit-card p-3 rounded-xl border ${borderColor} ${isDead || allActionsUsed ? 'filter grayscale opacity-60' : 'bg-slate-900/60'}">
                <div class="flex items-start justify-between">
                    <div class="flex-grow pr-4">
                        <div class="flex items-center gap-2">
                            ${!isHero ? `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold" title="Armor Class">${monster.ac}</div>` : ''}
                            <div data-action="select-unit" data-unit-id="${u.unitId}" class="font-medium text-sm cursor-pointer ${isDead ? 'line-through' : ''}">
                                <span>${isHero ? `★ ${u.name}` : u.name}</span>
                                <span class="opacity-60 text-xs flex items-center gap-1.5">${isHero ? u.label : `L${u.level} · ${u.org} · ${ROLE_ICONS[monster.role] || monster.role}`}</span>
                            </div>
                            <div class="flex gap-1">${conditionIcons}</div>
                        </div>
                        ${!isHero ? `<div class="h-2 rounded bg-slate-800 mt-1 mb-1 overflow-hidden"><div class="health-bar-inner h-2" style="width: ${pct}%; background-color: ${healthColor};"></div></div>` : '<div class="h-2"></div>'}
                        <div class="flex items-center gap-2">
                            <div class="text-xs opacity-80">
                                ${!isHero ? `HP ${u.hp}/${u.hpMax} · FS ${u.freeStrike}` : ''}
                                ${isBlooded ? `<span class="ml-2 text-rose-400 font-bold">Ensangrentado</span>` : ''}
                                ${isDead ? `<span class="ml-2 text-red-500 font-bold">Muerto</span>` : ''}
                            </div>
                            ${!isHero ? `<button data-action="toggle-unit-card" data-unit-id="${u.unitId}" class="text-xs font-bold bg-slate-700 hover:bg-slate-600 rounded-full w-5 h-5 flex items-center justify-center flex-shrink-0">${isOpen ? '−' : '+'}</button>` : ''}
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        ${!isHero ? `
                        <div class="flex items-center gap-2">
                            <input type="number" placeholder="Valor" class="w-20 bg-slate-800 rounded-lg px-2 py-1 text-xs" data-hp-input="${u.unitId}">
                            <button data-action="adjust-hp" data-unit-id="${u.unitId}" data-delta-sign="-1" class="px-2 py-1 bg-rose-800 hover:bg-rose-700 rounded-lg text-xs" ${isDead ? 'disabled' : ''}>Daño</button>
                            <button data-action="adjust-hp" data-unit-id="${u.unitId}" data-delta-sign="1" class="px-2 py-1 bg-emerald-800 hover:bg-emerald-700 rounded-lg text-xs">Sana</button>
                        </div>` : ''}
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-4 text-xs">
                    <label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="move" ${u.actionsUsed.move ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Movimiento</label>
                    <label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="attack1" ${u.actionsUsed.attack1 ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Ataque</label>
                    ${!isHero && u.maxAttacks > 1 ? `<label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="attack2" ${u.actionsUsed.attack2 ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Ataque 2</label>`: ''}
                    ${hasManeuver ? `<label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="maneuver" ${u.actionsUsed.maneuver ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Maniobra</label>` : ''}
                    ${isHero ? `<label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="bonusAction" ${u.actionsUsed.bonusAction ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Bonus Action</label>` : ''}
                    <div class="relative">
                        <button data-action="toggle-condition-dropdown" data-unit-id="${u.unitId}" class="px-2 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-md">Condiciones</button>
                        ${state.conditionDropdownOpen === u.unitId ? renderConditionDropdown(u) : ''}
                    </div>
                </div>
                ${isOpen && monster ? `
                    <div class="mt-2 text-[11px]">
                        <div class="border-b border-slate-800">
                            ${tabButton('acciones', 'Acciones')}
                            ${tabButton('rasgos', 'Rasgos')}
                        </div>
                        <div class="p-2 bg-slate-800 rounded-b-lg">
                            ${activeTab === 'acciones' ? `<div class="space-y-2">${monster.abilities.map(a => renderAbilityBlock(a, true, u.unitId)).join('')}</div>` : ''}
                            ${activeTab === 'rasgos' ? `<div class="space-y-2">${monster.traits.map(t => `<div><b>${t.name}.</b> ${t.text}</div>`).join('')}</div>` : ''}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    function renderHeroModal() {
        return `
            <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 w-full max-w-md space-y-4">
                    <h2 class="text-lg font-semibold">Agregar Héroes</h2>
                    <div id="hero-inputs" class="grid grid-cols-2 gap-4">
                        ${Array(8).fill(0).map((_, i) => `<input type="text" placeholder="Héroe ${i + 1}" class="bg-slate-800 rounded-lg px-3 py-2 text-sm w-full">`).join('')}
                    </div>
                    <div class="flex justify-end gap-4">
                        <button data-action="close-hero-modal" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Cerrar</button>
                        <button data-action="add-heroes" class="px-4 py-2 rounded-xl bg-blue-700 hover:bg-blue-600">Agregar</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderConditionDropdown(u) {
        return `
            <div class="absolute z-10 top-full mt-2 w-64 bg-slate-900 border border-slate-700 rounded-lg p-2 grid grid-cols-2 gap-2">
                ${Object.keys(CONDITIONS_MAP).map(c => `
                    <label class="flex items-center gap-1.5 text-xs cursor-pointer" title="${CONDITIONS_MAP[c]}">
                        <input type="checkbox" data-action="toggle-condition" data-unit-id="${u.unitId}" data-cond="${c}" class="form-checkbox h-4 w-4 rounded bg-slate-800 border-slate-600 text-blue-500" ${u.conditions.includes(c) ? 'checked' : ''}>
                        ${c.charAt(0).toUpperCase() + c.slice(1)}
                    </label>
                `).join('')}
            </div>
        `;
    }

    // --- EVENT LISTENERS & LOGIC ---
    function addEventListeners() {
        appContainer.addEventListener('click', handleAppClick);
        appContainer.addEventListener('input', handleAppInput);
        appContainer.addEventListener('change', handleAppChange);
        modalContainer.addEventListener('click', handleAppClick);
        
        const initiativeList = document.getElementById('initiative-list');
        if (initiativeList) {
            initiativeList.addEventListener('dragstart', handleDragStart);
            initiativeList.addEventListener('dragover', handleDragOver);
            initiativeList.addEventListener('dragleave', handleDragLeave);
            initiativeList.addEventListener('drop', handleDrop);
            initiativeList.addEventListener('dragend', handleDragEnd);
        }
        
        const libraryResizer = document.getElementById('library-resizer');
        if (libraryResizer) libraryResizer.addEventListener('mousedown', initResize);
        const initiativeResizer = document.getElementById('initiative-resizer');
        if (initiativeResizer) initiativeResizer.addEventListener('mousedown', initResize);
    }
    
    function handleAppClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) {
             if (state.conditionDropdownOpen && !e.target.closest('.relative')) {
                state.conditionDropdownOpen = null;
                render();
            }
            return;
        };

        const nonClickActions = ['set-placed-count'];
        if (nonClickActions.includes(target.dataset.action)) return;

        const { action, monsterId, instanceId, unitId, idx, dir, deltaSign, cond, tabName, abilityId, lairActionId, race, sceneId } = target.dataset;
        let stateChanged = true;

        switch(action) {
            case 'toggle-library': state.isLibraryOpen = !state.isLibraryOpen; break;
            case 'toggle-initiative': state.isInitiativeOpen = !state.isInitiativeOpen; break;
            case 'reset-filters': state.filters = { keywords: [], organizations: [], levels: [], q: '' }; break;
            case 'toggle-monster-card': state.openMonsterCards[monsterId] = !state.openMonsterCards[monsterId]; break;
            case 'toggle-race-group': state.collapsedRaceGroups = toggleInArray(state.collapsedRaceGroups, race); break;
            case 'add-monster':
                if (state.tracker) {
                    handleAddReinforcement(monsterId);
                } else {
                    const monster = getMonsterById(monsterId);
                    state.builder.push({ instanceId: `${monsterId}:${cryptoRandom()}`, monsterId, count: monster?.minion ? (monster.minionPerSquad || 4) : 1 });
                }
                break;
            case 'remove-placed': state.builder = state.builder.filter(p => p.instanceId !== instanceId); break;
            case 'start-encounter': handleStartEncounter(); break;
            case 'reset-builder': state.builder = []; document.getElementById('scene-name-input').value = ''; break;
            case 'end-encounter': state.tracker = null; state.selectedUnitId = null; break;
            case 'advance-turn': handleAdvanceTurn(); break;
            case 'move-initiative': handleMoveInitiative(parseInt(idx, 10), parseInt(dir, 10)); break;
            case 'toggle-unit-card': state.openUnitCards[unitId] = !state.openUnitCards[unitId]; break;
            case 'set-unit-tab': state.activeUnitTabs[unitId] = tabName; break;
            case 'adjust-hp': handleAdjustHp(unitId, deltaSign); break;
            case 'use-ability': handleUseAbility(unitId, abilityId); break;
            case 'select-unit': state.selectedUnitId = state.selectedUnitId === unitId ? null : unitId; break;
            case 'select-unit-from-initiative':
                state.selectedUnitId = state.selectedUnitId === unitId ? null : unitId;
                document.getElementById(`unit-${unitId}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                break;
            case 'open-hero-modal': state.isHeroModalOpen = true; break;
            case 'close-hero-modal': state.isHeroModalOpen = false; break;
            case 'add-heroes': handleAddHeroes(); break;
            case 'toggle-condition-dropdown': 
                state.conditionDropdownOpen = state.conditionDropdownOpen === unitId ? null : unitId;
                break;
            case 'toggle-condition': 
                handleToggleCondition(unitId, cond);
                break;
            case 'use-lair-action':
                const lairUnit = state.tracker.units.find(u => u.unitId === unitId);
                if (lairUnit) {
                    lairUnit.actionsUsed[lairActionId] = true;
                    handleAdvanceTurn();
                }
                break;
            case 'toggle-action':
                handleToggleAction(unitId, target.dataset.actionName, target.checked);
                break;
            case 'toggle-filters':
                state.isFiltersOpen = !state.isFiltersOpen;
                break;
            case 'save-scene': handleSaveScene(); break;
            case 'activate-scene': handleActivateScene(sceneId); break;
            case 'delete-scene': state.savedScenes = state.savedScenes.filter(s => s.id !== sceneId); break;
            default: stateChanged = false; break;
        }
        
        if (stateChanged) {
            saveState();
            render();
        }
    }

    function handleAppInput(e) {
        const target = e.target;
        if (target.id === 'search-input') {
            state.filters.q = target.value;
            render();
        } else if (target.dataset.partyField) {
            state.party[target.dataset.partyField] = target.value;
            saveState();
        } else if (target.dataset.action === 'set-placed-count') {
            const p = state.builder.find(p => p.instanceId === target.dataset.instanceId);
            if (p) p.count = Math.max(1, parseInt(target.value, 10) || 1);
            render();
        } else if (target.id === 'notes-textarea') {
            if(state.tracker) {
                state.tracker.notes = target.value;
                saveState();
            }
        }
    }

    function handleAppChange(e) {
        const target = e.target;
        if (target.dataset.filter) {
            const filterType = target.dataset.filter;
            const value = target.value;
            if (target.checked) {
                state.filters[filterType].push(value);
            } else {
                state.filters[filterType] = state.filters[filterType].filter(v => v !== value);
            }
            render();
        } else if (target.dataset.action === 'toggle-action') {
            handleToggleAction(target.dataset.unitId, target.dataset.actionName, target.checked);
            saveState();
        } else if (target.dataset.action === 'toggle-condition') {
            handleToggleCondition(target.dataset.unitId, target.dataset.cond);
            saveState();
            render();
        } else if (target.dataset.action === 'select-lair') {
            state.selectedLairId = target.value === 'none' ? null : target.value;
            saveState();
        }
    }
    
    // --- LOGIC FUNCTIONS ---
    function handleStartEncounter(scene = null) {
        const monsterList = scene ? scene.monsters : state.builder;
        const lairId = scene ? scene.lairId : state.selectedLairId;
        const units = [];
        
        monsterList.forEach(p => {
            const m = getMonsterById(p.monsterId);
            if (!m) return;
            const maxAttacks = m.level >= 2 ? 2 : 1;
            const baseUnit = { level: m.level, role: m.role, org: m.organization, freeStrike: m.freeStrike, monsterId: m.id, conditions: [], actionsUsed: { move: false, attack1: false, attack2: false, maneuver: false, bonusAction: false }, maxAttacks };
            if (m.organization === "minion") {
                units.push({ ...baseUnit, unitId: `${p.instanceId}-squad`, name: `${m.name}`, label: "Squad", hp: m.stamina * p.count, hpMax: m.stamina * p.count });
            } else {
                for (let i = 1; i <= p.count; i++) {
                    units.push({ ...baseUnit, unitId: `${p.instanceId}-${i}`, name: `${m.name} #${i}`, label: "", hp: m.stamina, hpMax: m.stamina });
                }
            }
        });
        
        const order = units.map(u => u.unitId);

        if (lairId) {
            const lair = getLairById(lairId);
            const lairUnit = {
                unitId: `lair-${cryptoRandom()}`,
                name: lair.name,
                label: "Acción de Guarida",
                role: 'lair',
                lairId: lair.id,
                actionsUsed: {},
                conditions: []
            };
            units.push(lairUnit);
            const randomIndex = Math.floor(Math.random() * (order.length));
            order.splice(randomIndex, 0, lairUnit.unitId);
        }

        state.tracker = {
            started: true, round: 1, order, turnIndex: 0, units,
            malice: units.filter(u => u.role !== 'hero' && u.role !== 'lair').length, 
            log: [{ t: Date.now(), msg: `Encounter started.` }], notes: ""
        };
    }

    function handleActivateScene(sceneId) {
        const scene = state.savedScenes.find(s => s.id === sceneId);
        if (scene) {
            handleStartEncounter(scene);
        }
    }

    function handleSaveScene() {
        const nameInput = document.getElementById('scene-name-input');
        const name = nameInput.value.trim();
        if (!name || state.builder.length === 0) return;

        const newScene = {
            id: cryptoRandom(),
            name,
            monsters: JSON.parse(JSON.stringify(state.builder)),
            lairId: state.selectedLairId
        };

        state.savedScenes.push(newScene);
        state.builder = [];
        nameInput.value = '';
    }

    function handleAdvanceTurn() {
        if (!state.tracker) return;
        const t = state.tracker;
        t.turnIndex = (t.turnIndex + 1) % t.order.length;
        if (t.turnIndex === 0) {
            t.round++;
            t.units.forEach(u => {
                u.actionsUsed = { move: false, attack1: false, attack2: false, maneuver: false, bonusAction: false };
                if (u.role === 'lair') u.actionsUsed = {};
            });
        }
        const nextUnitId = t.order[t.turnIndex];
        const nextUnit = t.units.find(u => u.unitId === nextUnitId);
        if (nextUnit && nextUnit.role !== 'lair') {
            nextUnit.actionsUsed = { move: false, attack1: false, attack2: false, maneuver: false, bonusAction: false };
        }
    }

    function handleMoveInitiative(idx, dir) {
        const { order } = state.tracker;
        const j = idx + dir;
        if (j < 0 || j >= order.length) return;
        [order[idx], order[j]] = [order[j], order[idx]];
    }

    function handleAdjustHp(unitId, deltaSign) {
        const input = document.querySelector(`[data-hp-input="${unitId}"]`);
        const value = parseInt(input.value, 10);
        if (isNaN(value) || value <= 0) return;
        
        const delta = value * parseInt(deltaSign, 10);
        const unit = state.tracker.units.find(u => u.unitId === unitId);
        const oldHp = unit.hp;
        unit.hp = Math.max(0, unit.hp + delta);
        if (oldHp > 0 && unit.hp === 0) {
            state.tracker.malice++;
        }
        input.value = '';

        const unitCard = document.getElementById(`unit-${unitId}`);
        if (unitCard) {
            const floatEl = document.createElement('div');
            floatEl.textContent = `${delta > 0 ? '+' : ''}${delta}`;
            floatEl.className = `damage-float ${delta > 0 ? 'text-emerald-400' : 'text-rose-500'}`;
            unitCard.appendChild(floatEl);
            setTimeout(() => floatEl.remove(), 1000);
        }
    }

    function handleToggleAction(unitId, actionName, isChecked) {
        const unit = state.tracker.units.find(u => u.unitId === unitId);
        if (!unit) return;

        unit.actionsUsed[actionName] = isChecked;

        const monster = getMonsterById(unit.monsterId);
        const isHero = unit.role === 'hero';
        const hasManeuver = !isHero && monster?.abilities?.some(a => a.action === 'maneuver');
        
        let allActionsUsed = false;
        if (isHero) {
            allActionsUsed = unit.actionsUsed.move && unit.actionsUsed.attack1 && unit.actionsUsed.bonusAction;
        } else {
            const attacksDone = unit.maxAttacks === 1 ? unit.actionsUsed.attack1 : (unit.actionsUsed.attack1 && unit.actionsUsed.attack2);
            allActionsUsed = unit.actionsUsed.move && attacksDone && (!hasManeuver || unit.actionsUsed.maneuver);
        }

        if (allActionsUsed) {
            setTimeout(() => {
                handleAdvanceTurn();
                saveState();
                render();
            }, 300);
        } else {
            render();
        }
    }

    function handleToggleCondition(unitId, cond) {
        const unit = state.tracker.units.find(u => u.unitId === unitId);
        if (unit) unit.conditions = toggleInArray(unit.conditions, cond);
    }
    
    function handleUseAbility(unitId, abilityId) {
        const unit = state.tracker.units.find(u => u.unitId === unitId);
        if (!unit) return;
        const monster = getMonsterById(unit.monsterId);
        const ability = monster.abilities.find(a => a.id === abilityId);
        if (!ability || (ability.malice && state.tracker.malice < ability.malice)) return;

        if (ability.malice) state.tracker.malice -= ability.malice;
        
        if (ability.action === 'main') {
            if (!unit.actionsUsed.attack1) unit.actionsUsed.attack1 = true;
            else if (unit.maxAttacks > 1 && !unit.actionsUsed.attack2) unit.actionsUsed.attack2 = true;
        }
        if (ability.action === 'maneuver') unit.actionsUsed.maneuver = true;

        const hasManeuver = monster?.abilities?.some(a => a.action === 'maneuver');
        const attacksDone = unit.maxAttacks === 1 ? unit.actionsUsed.attack1 : (unit.actionsUsed.attack1 && unit.actionsUsed.attack2);
        const allActionsUsed = unit.actionsUsed.move && attacksDone && (!hasManeuver || unit.actionsUsed.maneuver);

        if (allActionsUsed) {
             setTimeout(() => {
                handleAdvanceTurn();
                saveState();
                render();
            }, 300);
        }
    }
    
    function handleAddHeroes() {
        const inputs = document.querySelectorAll('#hero-inputs input');
        const names = Array.from(inputs).map(input => input.value.trim()).filter(name => name);
        if (names.length === 0) {
            state.isHeroModalOpen = false;
            return;
        }

        const t = state.tracker;
        if (!t) return;

        names.forEach(name => {
            const unitId = `hero-${cryptoRandom()}`;
            const hero = {
                unitId, name, label: "Héroe", level: "—", role: "hero", org: "hero",
                monsterId: null, freeStrike: "—", hp: 0, hpMax: 0,
                actionsUsed: { move: false, attack1: false, attack2: false, maneuver: false, bonusAction: false },
                maxAttacks: 1,
                conditions: []
            };
            t.units.push(hero);
            t.order.push(unitId);
        });
        
        state.isHeroModalOpen = false;
    }
    
    function handleAddReinforcement(monsterId) {
        const m = getMonsterById(monsterId);
        if (!m || !state.tracker) return;
        const maxAttacks = m.level >= 2 ? 2 : 1;
        const baseUnit = { level: m.level, role: m.role, org: m.organization, freeStrike: m.freeStrike, monsterId: m.id, conditions: [], actionsUsed: { move: false, attack1: false, attack2: false, maneuver: false, bonusAction: false }, maxAttacks };
        
        if (m.organization === "minion") {
            const unitId = `${m.id}:${cryptoRandom()}-squad`;
            const newUnit = { ...baseUnit, unitId, name: `${m.name}`, label: "Squad", hp: m.stamina * m.minionPerSquad, hpMax: m.stamina * m.minionPerSquad };
            state.tracker.units.push(newUnit);
            state.tracker.order.push(unitId);
        } else {
            const unitId = `${m.id}:${cryptoRandom()}-1`;
            const newUnit = { ...baseUnit, unitId, name: `${m.name} (Refuerzo)`, label: "", hp: m.stamina, hpMax: m.stamina };
            state.tracker.units.push(newUnit);
            state.tracker.order.push(unitId);
        }
    }

    // --- DRAG & DROP LOGIC ---
    let draggedUnitId = null;

    function handleDragStart(e) {
        draggedUnitId = e.target.dataset.unitId;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        e.preventDefault();
        const target = e.target.closest('[draggable]');
        if (target && target.dataset.unitId !== draggedUnitId) {
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
        }
    }
    
    function handleDragLeave(e) {
        e.target.closest('[draggable]')?.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        const target = e.target.closest('[draggable]');
        if (target && draggedUnitId) {
            const targetUnitId = target.dataset.unitId;
            const { order } = state.tracker;
            const draggedIndex = order.indexOf(draggedUnitId);
            const targetIndex = order.indexOf(targetUnitId);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                const [draggedItem] = order.splice(draggedIndex, 1);
                order.splice(targetIndex, 0, draggedItem);
                saveState();
                render();
            }
        }
        draggedUnitId = null;
    }
    
    function handleDragEnd(e) {
        document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    // --- RESIZER LOGIC (completo) ---
    let currentResizer = null;
    let startX = 0;
    let startWidth = 0;
    let containerWidth = 0;

    function initResize(e) {
      currentResizer = e.target;
      const panelId = currentResizer.dataset.panel; // "library" | "initiative"
      const panelEl = document.getElementById(`${panelId}-container`);
      const root = document.getElementById('app-container');

      startX = e.clientX;
      startWidth = panelEl.getBoundingClientRect().width;
      containerWidth = root.getBoundingClientRect().width;

      window.addEventListener('mousemove', resize);
      window.addEventListener('mouseup', stopResize);
    }

    function resize(e) {
      if (!currentResizer) return;
      const panelId = currentResizer.dataset.panel;
      const delta = e.clientX - startX;

      // Si arrastras el separador de iniciativa, la lógica se invierte respecto al borde derecho
      let newPx;
      if (panelId === 'library') {
        newPx = Math.max(160, startWidth + delta);
      } else {
        newPx = Math.max(160, startWidth - delta);
      }

      // Limita a 15%–60% del ancho total para no colapsar el layout
      let newPct = Math.round((newPx / containerWidth) * 100);
      newPct = Math.max(15, Math.min(60, newPct));

      state.panelWidths[panelId] = `${newPct}%`;
      // Pintado inmediato sin esperar a mouseup
      const target = document.getElementById(`${panelId}-container`);
      if (target) target.style.width = state.panelWidths[panelId];
    }

    function stopResize() {
      window.removeEventListener('mousemove', resize);
      window.removeEventListener('mouseup', stopResize);
      currentResizer = null;
      saveState();
    }

    // --- BOOTSTRAP ---
    window.addEventListener('DOMContentLoaded', () => {
      try {
        initState();
        render();
      } catch (err) {
        console.error('[Encounter Toolkit] fallo en bootstrap:', err);
        const root = document.getElementById('app-container');
        if (root) {
          root.innerHTML = `<div style="padding:16px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;border-radius:12px;">
            <div style="font-weight:600;margin-bottom:8px;">Error inicializando la app</div>
            <pre style="white-space:pre-wrap;font-size:12px;opacity:.8;">${String(err)}</pre>
          </div>`;
        }
      }
    });
    </script>
</body>
</html>
