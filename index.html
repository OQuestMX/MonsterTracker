<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encounter Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .unit-card {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 p-4">

    <div id="app-container" class="flex flex-col h-screen max-h-screen">
        <!-- App content will be rendered here by JavaScript -->
    </div>
    <div id="modal-container"></div>

    <script>
    // --- DATA (SEED MONSTERS) ---
    const SEED_MONSTERS=[{id:"orc-godcaller-platoon-l1",name:"Orc Godcaller",level:1,organization:"platoon",role:"support",ev:6,stamina:30,freeStrike:3,size:"1M",speed:6,keywords:["humanoid","orc"],source:"User Image",attributes:{might:1,agility:0,reason:0,intuition:1,presence:2},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Relentless",text:"If the godcaller is reduced to 0 Stamina, they can make a free strike before dying. If the target of the free strike is reduced to 0 Stamina, the godcaller is reduced to 1 Stamina instead."}],abilities:[{id:"power-chord",type:"signature",name:"Power Chord 2d10 + 2",action:"main",distance:"melee 1 or ranged 10",keywords:["Magic","Melee","Ranged","Strike"],text:"One creature or object.",tiers:[{threshold:"≤11",effect:"5 sonic damage"},{threshold:"12-16",effect:"7 sonic damage"},{threshold:"17+",effect:"9 sonic damage; P<2 weakened (save ends)"}]},{id:"cadenza",type:"action",name:"Cadenza",action:"main",distance:"ranged 10",keywords:["Magic","Ranged"],text:"One ally. Effect: The target moves up to their speed and can use a main action. 3 Malice: The godcaller targets a second ally.",malice:3},{id:"rallying-ostinato",type:"maneuver",name:"Rallying Ostinato",action:"maneuver",distance:"ranged 10",malice:2,keywords:["Magic","Ranged"],text:"Self and three allies. Effect: Each target regains 15 Stamina and ignores difficult terrain until the end of the encounter."}]},{id:"human-storm-mage-platoon-l3",name:"Human Storm Mage",level:3,organization:"platoon",role:"controller",ev:10,stamina:40,freeStrike:5,size:"1M",speed:5,keywords:["human","humanoid"],source:"User Image",attributes:{might:0,agility:0,reason:2,intuition:0,presence:1},immunities:["Corruption 3","Psychic 3"],weaknesses:[],resistances:[],traits:[{name:"Arcane Shield",text:"Any melee ability targeting the storm mage takes a bane. Additionally, whenever the mage takes damage from an adjacent enemy, the enemy takes 2 lightning damage, and if they have R<1 they are pushed up to 2 squares."},{name:"Supernatural Insight",text:"The storm mage ignores concealment if it’s granted by a supernatural effect."}],abilities:[{id:"lightning-bolt",type:"signature",name:"Lightning Bolt 2d10 + 2",action:"main",distance:"ranged 15",keywords:["Magic","Ranged","Strike"],text:"One creature or object. 5 Malice: The ability loses the Ranged and Strike keywords, takes the Area keyword, and is a 10 x 1 line within 15 that targets each enemy and object in the area.",malice:5,tiers:[{threshold:"≤11",effect:"7 lightning damage"},{threshold:"12-16",effect:"10 lightning damage"},{threshold:"17+",effect:"13 lightning damage"}]},{id:"gust-of-wind",type:"maneuver",name:"Gust of Wind 2d10 + 2",action:"maneuver",area:"5 cube within 1",malice:3,keywords:["Area","Magic"],text:"Each enemy and object in the area. Effect: The gust of wind disperses gas or vapor and extinguishes any flames, including supernatural effects.",tiers:[{threshold:"≤11",effect:"Slide 2; M<0 slowed (save ends)"},{threshold:"12-16",effect:"Slide 4; M<1 slowed (save ends)"},{threshold:"17+",effect:"Slide 6; M<2 slowed (save ends)"}]}]},{id:"hobgoblin-burning-witch-platoon-l4",name:"Hobgoblin Burning Witch",level:4,organization:"platoon",role:"controller",ev:12,stamina:50,freeStrike:5,size:"1M",speed:5,keywords:["goblin","hobgoblin","humanoid","infernal"],source:"User Image",notes:{movement:"Teleport"},attributes:{might:0,agility:1,reason:2,intuition:2,presence:3},immunities:["Fire"],weaknesses:[],resistances:[],traits:[{name:"Infernal Ichor",text:"When the burning witch is reduced to 0 Stamina, they spray burning blood. Each creature adjacent to the burning witch takes 3 fire damage."}],abilities:[{id:"soul-burn",type:"signature",name:"Soul Burn 2d10 + 3",action:"main",distance:"ranged 10",keywords:["Magic","Ranged","Strike"],text:"Two creatures or objects. 2 Malice: Each target who has P<2 is weakened (save ends). Any enemy who starts their turn within 3 squares of a target weakened this way and who has P<2 is weakened (save ends).",malice:2,tiers:[{threshold:"≤11",effect:"4 corruption or fire damage"},{threshold:"12-16",effect:"6 corruption or fire damage"},{threshold:"17+",effect:"8 corruption or fire damage"}]},{id:"burning-legion",type:"maneuver",name:"Burning Legion",action:"maneuver",distance:"ranged 10",malice:1,keywords:["Magic","Ranged"],text:"Three creatures. Effect: Each target can teleport up to 5 squares. Each creature adjacent to a target at their destination takes 3 fire damage."}]},{id:"goblin-spinecleaver-minion-l1",name:"Goblin Spinecleaver (Squad)",level:1,organization:"minion",role:"brute",ev:3,stamina:5,freeStrike:2,size:"1S",speed:5,keywords:["goblin","humanoid"],source:"Monsters PDF p.161–162",minion:!0,minionPerSquad:4,notes:{movement:"Climb",withCaptain:"+1 damage bonus to strikes"},attributes:{might:2,agility:0,reason:0,intuition:0,presence:-1},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The spinecleaver doesn’t provoke opportunity attacks by moving."}],abilities:[{id:"axe",type:"signature",name:"Axe 2d10 + 2",action:"main",distance:"melee 1",keywords:["Melee","Strike","Weapon"],text:"One creature or object per minion.",tiers:[{threshold:"≤11",effect:"2 damage; push 1"},{threshold:"12–16",effect:"4 damage; push 3"},{threshold:"17+",effect:"5 damage; push 4"}]}]},{id:"goblin-sniper-minion-l1",name:"Goblin Sniper (Squad)",level:1,organization:"minion",role:"artillery",ev:3,stamina:3,freeStrike:2,size:"1S",speed:5,keywords:["goblin","humanoid"],source:"Monsters PDF p.161",minion:!0,minionPerSquad:4,notes:{movement:"Climb",withCaptain:"+5 bonus to ranged distance"},attributes:{might:-2,agility:2,reason:0,intuition:0,presence:-1},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The sniper doesn’t provoke opportunity attacks by moving."}],abilities:[{id:"bow",type:"signature",name:"Bow 2d10 + 2",action:"main",distance:"ranged 10",keywords:["Ranged","Strike","Weapon"],text:"One creature or object per minion. If the sniper doesn’t use a move action this turn, this ability gains an edge.",tiers:[{threshold:"≤11",effect:"2 damage"},{threshold:"12–16",effect:"4 damage"},{threshold:"17+",effect:"5 damage"}]}]},{id:"goblin-assassin-horde-l1",name:"Goblin Assassin",level:1,organization:"horde",role:"ambusher",ev:3,stamina:15,freeStrike:2,size:"1S",speed:6,keywords:["goblin","humanoid"],source:"Monsters PDF p.162",notes:{movement:"Climb"},attributes:{might:-2,agility:2,reason:0,intuition:0,presence:-2},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The assassin doesn’t provoke opportunity attacks by moving."},{name:"Slip Away",text:"The assassin can attempt to hide even while observed."}],abilities:[{id:"stab",type:"signature",name:"Sword Stab 2d10 + 2",action:"main",distance:"melee 1",keywords:["Melee","Strike","Weapon"],text:"One creature or object.",tiers:[{threshold:"≤11",effect:"4 damage"},{threshold:"12–16",effect:"6 damage"},{threshold:"17+",effect:"7 damage"}],onHit:"If this ability gains an edge or has a double edge, it deals an extra 2 damage."},{id:"chains",type:"action",name:"Shadow Chains 2d10 + 2",action:"main",distance:"ranged 10",keywords:["Magic","Ranged","Strike"],text:"Three creatures.",malice:3,tiers:[{threshold:"≤11",effect:"2 corruption damage; A<0 restrained (save ends)"},{threshold:"12–16",effect:"4 corruption damage; A<1 restrained (save ends)"},{threshold:"17+",effect:"5 corruption damage; A<2 restrained (save ends)"}]}]},{id:"goblin-cursespitter-horde-l1",name:"Goblin Cursespitter",level:1,organization:"horde",role:"hexer",ev:3,stamina:10,freeStrike:1,size:"1S",speed:5,keywords:["goblin","humanoid"],source:"Monsters PDF p.163",notes:{movement:"Climb"},attributes:{might:-2,agility:1,reason:0,intuition:2,presence:0},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The cursespitter doesn’t provoke opportunity attacks by moving."}],abilities:[{id:"eye",type:"signature",name:"Eye of Surlach 2d10 + 2",action:"main",distance:"ranged 15",keywords:["Magic","Ranged","Strike"],text:"One creature.",tiers:[{threshold:"≤11",effect:"3 corruption damage; K<0 weakened (save ends)"},{threshold:"12–16",effect:"4 corruption damage; K<1 weakened (save ends)"},{threshold:"17+",effect:"5 corruption damage; K<2 weakened (save ends)"}]},{id:"hex",type:"maneuver",name:"Dizzying Hex 2d10 + 2",action:"maneuver",distance:"ranged 10",malice:1,keywords:["Magic","Ranged","Strike"],text:"One creature.",tiers:[{threshold:"≤11",effect:"K<0 prone"},{threshold:"12–16",effect:"K<1 prone and can’t stand (EoT)"},{threshold:"17+",effect:"Prone; K<2 can’t stand (save ends)"}]}]},{id:"goblin-warrior-horde-l1",name:"Goblin Warrior",level:1,organization:"horde",role:"harrier",ev:3,stamina:15,freeStrike:1,size:"1S",speed:6,keywords:["goblin","humanoid"],source:"Monsters PDF p.164",notes:{movement:"Climb"},attributes:{might:-2,agility:2,reason:0,intuition:0,presence:-1},immunities:[],weaknesses:[],resistances:[],traits:[{name:"Crafty",text:"The warrior doesn’t provoke opportunity attacks by moving."}],abilities:[{id:"spear",type:"signature",name:"Spear Charge 2d10 + 2",action:"main",distance:"melee 1",keywords:["Charge","Melee","Strike","Weapon"],text:"One creature or object.",tiers:[{threshold:"≤11",effect:"3 damage"},{threshold:"12–16",effect:"4 damage"},{threshold:"17+",effect:"5 damage"}]},{id:"bury",type:"action",name:"Bury the Point 2d10 + 2",action:"main",distance:"melee 1",malice:2,keywords:["Melee","Strike","Weapon"],text:"One creature.",tiers:[{threshold:"≤11",effect:"5 damage; M<0 bleeding (save ends)"},{threshold:"12–16",effect:"6 damage; M<1 bleeding (save ends)"},{threshold:"17+",effect:"7 damage; M<3 bleeding (save ends)"}]}]}];

    const CONDITIONS_MAP = {
        prone: "Derribado: Atacantes cuerpo a cuerpo tienen ventaja. Atacantes a distancia tienen desventaja. El personaje tiene desventaja en ataques.",
        grabbed: "Agarrado: La velocidad se vuelve 0.",
        stunned: "Aturdido: No puede realizar acciones ni reacciones. Falla automáticamente salvaciones de Fuerza y Destreza.",
        weakened: "Debilitado: Tiene desventaja en tiradas de ataque y salvaciones basadas en Fuerza, Destreza o Constitución.",
        dazed: "Atontado: No puede tomar reacciones y solo puede realizar una acción (movimiento o ataque).",
        blinded: "Cegado: Falla cualquier prueba de habilidad que requiera vista. Desventaja en tiradas de ataque. Los ataques en su contra tienen ventaja.",
        restrained: "Inmovilizado: Velocidad 0. Desventaja en ataques y salvaciones de Destreza. Ataques en su contra tienen ventaja.",
        slowed: "Ralentizado: Velocidad reducida a la mitad. -2 a la CA y salvaciones de Destreza.",
        poisoned: "Envenenado: Desventaja en tiradas de ataque y pruebas de habilidad."
    };

    // --- STATE MANAGEMENT ---
    const LS_KEY = "ds_encounter_html_v4";
    let state = {};

    function initState() {
        const defaultState = {
            isLibraryOpen: true,
            isInitiativeOpen: true,
            builder: [],
            tracker: null,
            party: { teamName: "Aventureros", director: "Director del Juego" },
            filters: { keyword: 'all', organization: 'all', level: 'all', q: '' },
            openMonsterCards: {},
            openUnitCards: {},
            activeUnitTabs: {},
            selectedUnitId: null,
            isHeroModalOpen: false,
        };
        try {
            const loadedState = JSON.parse(localStorage.getItem(LS_KEY));
            state = { ...defaultState, ...(loadedState || {}) };
        } catch (e) {
            console.error("Failed to load state, using defaults:", e);
            state = defaultState;
        }
    }

    function saveState() {
        try {
            const stateToSave = { ...state, openMonsterCards: {}, openUnitCards: {}, activeUnitTabs: {} };
            localStorage.setItem(LS_KEY, JSON.stringify(stateToSave));
        } catch (e) {
            console.error("Failed to save state:", e);
        }
    }
    
    // --- HELPERS ---
    function fmtMod(n) { return n > 0 ? `+${n}` : String(n); }
    function cryptoRandom() {
        if (typeof crypto !== "undefined" && crypto.getRandomValues) {
            const a = new Uint32Array(1); crypto.getRandomValues(a); return a[0].toString(36);
        }
        return Math.random().toString(36).slice(2);
    }
    function getMonsterById(id) {
        return SEED_MONSTERS.find(m => m.id === id);
    }
    function toggleInArray(arr, val) {
        return arr.includes(val) ? arr.filter(v => v !== val) : [...arr, val];
    }

    // --- RENDER FUNCTIONS ---
    const appContainer = document.getElementById('app-container');
    const modalContainer = document.getElementById('modal-container');

    function render() {
        const { isLibraryOpen, isInitiativeOpen, tracker, party, isHeroModalOpen } = state;
        
        let gridCols = "grid-cols-12";
        let libraryColSpan = isLibraryOpen ? "col-span-3" : "col-span-1";
        let mainColSpan = "col-span-6";
        let initiativeColSpan = isInitiativeOpen ? "col-span-3" : "col-span-1";

        if (!isLibraryOpen && isInitiativeOpen) { mainColSpan = "col-span-8"; }
        if (isLibraryOpen && !isInitiativeOpen) { mainColSpan = "col-span-8"; }
        if (!isLibraryOpen && !isInitiativeOpen) { mainColSpan = "col-span-10"; }


        appContainer.innerHTML = `
            <header class="flex-shrink-0">
                ${tracker ? renderTrackerHeader(party, tracker) : ''}
            </header>

            <main class="flex-grow grid ${gridCols} gap-4 overflow-hidden">
                <div id="library-container" class="transition-all duration-300 ${libraryColSpan}">
                    ${renderLibraryPanel()}
                </div>

                <div id="main-container" class="transition-all duration-300 ${mainColSpan} flex flex-col space-y-4 overflow-auto custom-scrollbar">
                    ${!tracker ? renderBuilderPanel() : ''}
                    ${tracker ? renderTrackerPanel() : ''}
                </div>
                
                <div id="initiative-container" class="transition-all duration-300 ${initiativeColSpan}">
                    ${tracker ? renderInitiativePanel() : ''}
                </div>
            </main>
        `;
        
        modalContainer.innerHTML = isHeroModalOpen ? renderHeroModal() : '';
        addEventListeners();
    }

    function renderTrackerHeader(party, tracker) {
        return `
            <div class="bg-slate-900 border border-slate-800 rounded-2xl p-3 mb-4 flex justify-between items-center">
                <div class="flex items-center gap-4 text-sm">
                    <div>
                        <span class="opacity-70">Equipo: </span>
                        <input type="text" data-party-field="teamName" value="${party.teamName}" class="bg-slate-800 rounded px-2 py-1 w-40"/>
                    </div>
                    <div>
                        <span class="opacity-70">Director: </span>
                        <input type="text" data-party-field="director" value="${party.director}" class="bg-slate-800 rounded px-2 py-1 w-40"/>
                    </div>
                </div>
                <div class="flex items-center gap-6 text-right">
                    <div>
                        <div class="text-xs opacity-70">Ronda</div>
                        <div class="text-lg font-semibold">${tracker.round}</div>
                    </div>
                    <div>
                        <div class="text-xs opacity-70">Turno</div>
                        <div class="text-lg font-semibold">${tracker.order.length > 0 ? tracker.turnIndex + 1 : 0}/${tracker.order.length}</div>
                    </div>
                    <div>
                        <div class="text-xs opacity-70">Unidades</div>
                        <div class="text-lg font-semibold">${tracker.units.length}</div>
                    </div>
                    <div>
                        <div class="text-xs opacity-70">Malice</div>
                        <div class="text-2xl font-bold text-violet-400">${tracker.malice}</div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderLibraryPanel() {
        const { filters, isLibraryOpen } = state;
        const filterOptions = (() => {
            const keywords = [...new Set(SEED_MONSTERS.flatMap(m => m.keywords))].sort();
            const organizations = [...new Set(SEED_MONSTERS.map(m => m.organization))].sort();
            const levels = [...new Set(SEED_MONSTERS.map(m => m.level))].sort((a,b) => a - b);
            return { keywords, organizations, levels };
        })();

        const filteredMonsters = SEED_MONSTERS.filter(m => {
            const nameMatch = filters.q === "" || m.name.toLowerCase().includes(filters.q.toLowerCase());
            const keywordMatch = filters.keyword === 'all' || m.keywords.includes(filters.keyword);
            const orgMatch = filters.organization === 'all' || m.organization === filters.organization;
            const levelMatch = filters.level === 'all' || m.level === parseInt(filters.level, 10);
            return nameMatch && keywordMatch && orgMatch && levelMatch;
        }).sort((a, b) => a.name.localeCompare(b.name));

        return `
            <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-2 h-full flex flex-col">
                <div class="flex justify-between items-center">
                    <div class="font-medium ${!isLibraryOpen ? 'hidden' : ''}">Biblioteca</div>
                    <button data-action="toggle-library" class="px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs">
                        ${isLibraryOpen ? '<<' : '>>'}
                    </button>
                </div>
                <div class="${!isLibraryOpen ? 'hidden' : ''}">
                    <input id="search-input" class="w-full bg-slate-800 rounded-lg px-2 py-1 text-sm" placeholder="Buscar por nombre..." value="${filters.q}" />
                    
                    <div class="grid grid-cols-3 gap-2 text-xs mt-2">
                        <select data-filter="keyword" class="w-full bg-slate-800 rounded-lg px-2 py-1">
                            <option value="all">Raza</option>
                            ${filterOptions.keywords.map(k => `<option value="${k}" ${filters.keyword === k ? 'selected' : ''}>${k}</option>`).join('')}
                        </select>
                        <select data-filter="organization" class="w-full bg-slate-800 rounded-lg px-2 py-1">
                            <option value="all">Organización</option>
                            ${filterOptions.organizations.map(o => `<option value="${o}" ${filters.organization === o ? 'selected' : ''}>${o}</option>`).join('')}
                        </select>
                        <select data-filter="level" class="w-full bg-slate-800 rounded-lg px-2 py-1">
                            <option value="all">Nivel</option>
                            ${filterOptions.levels.map(l => `<option value="${l}" ${filters.level == l ? 'selected' : ''}>${l}</option>`).join('')}
                        </select>
                    </div>
                    <button data-action="reset-filters" class="w-full text-center py-1 mt-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs">Limpiar filtros</button>
                </div>

                <div class="flex-grow overflow-auto divide-y divide-slate-800 mt-2 custom-scrollbar pr-2 ${!isLibraryOpen ? 'hidden' : ''}">
                    ${filteredMonsters.map(m => renderMonsterCard(m)).join('')}
                </div>
            </div>
        `;
    }

    function renderMonsterCard(m) {
        const isOpen = state.openMonsterCards[m.id];
        return `
            <div class="py-2">
                <div class="flex items-center justify-between">
                    <div data-action="toggle-monster-card" data-monster-id="${m.id}" class="cursor-pointer flex-grow pr-4">
                        <div class="text-sm font-medium">${m.name}</div>
                        <div class="text-xs opacity-70">L${m.level} · ${m.organization} · ${m.role} · EV ${m.ev} · FS ${m.freeStrike}</div>
                        <div class="text-[10px] opacity-60">${m.size} · Speed ${m.speed} · ${m.source}</div>
                    </div>
                    <button data-action="add-monster" data-monster-id="${m.id}" class="px-2 py-1 bg-slate-800 rounded-lg hover:bg-slate-700 text-xs flex-shrink-0">Add</button>
                </div>
                ${isOpen ? `
                    <div class="mt-2 text-xs bg-slate-900/60 border border-slate-800 rounded-lg p-2 space-y-2">
                        ${m.notes ? `<div class="flex gap-4">${m.notes.movement ? `<div><div class="opacity-70">Movement</div><div>${m.notes.movement}</div></div>` : ''}${m.notes.withCaptain ? `<div><div class="opacity-70">With Captain</div><div>${m.notes.withCaptain}</div></div>` : ''}</div>` : ''}
                        ${m.attributes ? `<div><div class="font-medium mb-1">Attributes</div><div>Might ${fmtMod(m.attributes.might)} · Agility ${fmtMod(m.attributes.agility)} · Reason ${fmtMod(m.attributes.reason)} · Intuition ${fmtMod(m.attributes.intuition)} · Presence ${fmtMod(m.attributes.presence)}</div></div>` : ''}
                        ${m.traits?.length ? `<div><div class="font-medium mb-1">Traits</div><ul class="list-disc ml-4">${m.traits.map(t => `<li><b>${t.name}.</b> ${t.text}</li>`).join('')}</ul></div>` : ''}
                        ${m.abilities?.length ? `<div><div class="font-medium mb-1">Abilities</div><div class="space-y-2">${m.abilities.map(a => renderAbilityBlock(a)).join('')}</div></div>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }

    function renderAbilityBlock(ability, isTracker = false, unitId = null) {
        const canAfford = isTracker && ability.malice ? state.tracker.malice >= ability.malice : true;
        const clickableClass = isTracker && canAfford ? 'border-slate-800 hover:border-slate-600 cursor-pointer' : 'border-slate-800';
        return `
            <div data-action="${isTracker ? 'use-ability' : ''}" data-ability-id="${ability.id}" ${isTracker ? `data-unit-id="${unitId}"` : ''} class="p-2 rounded border ${clickableClass} ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}">
                <div class="flex items-center justify-between">
                    <div class="font-medium">${ability.name} ${ability.type === 'signature' ? `<span class="opacity-60">(Signature)</span>` : ''}</div>
                    <div class="opacity-70">${ability.action}</div>
                </div>
                <div class="opacity-80">${ability.distance || ''}${ability.area ? ` · ${ability.area}` : ''}${ability.keywords?.length ? ` · ${ability.keywords.join(', ')}` : ''}${ability.malice ? `<span class="font-bold text-violet-400"> · Malice ${ability.malice}</span>` : ''}${ability.usage ? ` · ${ability.usage}` : ''}</div>
                ${ability.tiers?.length ? `<div class="mt-1">${ability.tiers.map(t => `<div>${t.threshold}: ${t.effect}</div>`).join('')}</div>` : ''}
                ${ability.onHit ? `<div>On Hit: ${ability.onHit}</div>` : ''}
                ${ability.text ? `<div>${ability.text}</div>` : ''}
                ${ability.trigger ? `<div>Trigger: ${ability.trigger}</div>` : ''}
            </div>
        `;
    }

    function renderBuilderPanel() {
        const { builder } = state;
        const totalEV = builder.reduce((acc, p) => {
            const m = getMonsterById(p.monsterId);
            if (!m) return acc;
            if (m.organization === 'minion') return acc + m.ev;
            return acc + m.ev * (p.count || 1);
        }, 0);
        const totalUnits = builder.reduce((acc, p) => acc + (getMonsterById(p.monsterId)?.organization === 'minion' ? 1 : (p.count || 1)), 0);

        return `
            <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-3">
                <div class="flex items-center justify-between">
                    <div class="font-medium">Creador de Encuentros</div>
                    <div class="flex gap-2">
                        <button data-action="start-encounter" class="px-3 py-1.5 rounded-xl bg-emerald-700 hover:bg-emerald-600 disabled:opacity-40" ${builder.length === 0 ? 'disabled' : ''}>Iniciar</button>
                        <button data-action="reset-builder" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700">Limpiar</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="rounded-xl bg-slate-900/70 border border-slate-800 p-3"><div class="text-xs opacity-70">Total EV</div><div class="text-lg font-semibold">${totalEV}</div></div>
                    <div class="rounded-xl bg-slate-900/70 border border-slate-800 p-3"><div class="text-xs opacity-70"># Unidades</div><div class="text-lg font-semibold">${totalUnits}</div></div>
                </div>
                <div class="space-y-2">
                    ${builder.length === 0 ? `<div class="text-sm opacity-70">Añade monstruos desde la biblioteca.</div>` : builder.map(p => renderPlacedMonster(p)).join('')}
                </div>
            </div>
        `;
    }
    
    function renderPlacedMonster(p) {
        const m = getMonsterById(p.monsterId);
        if (!m) return '';
        const countLabel = m.organization === 'minion' ? 'Minions' : 'Copias';
        return `
            <div class="p-3 rounded-xl border border-slate-800 bg-slate-900/60">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium">${m.name}</div>
                        <div class="text-xs opacity-70">L${m.level} · ${m.organization} · ${m.role} · EV ${m.ev} · FS ${m.freeStrike}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1 text-xs">
                            <span>${countLabel}</span>
                            <input type="number" min="1" max="32" data-action="set-placed-count" data-instance-id="${p.instanceId}" class="w-16 bg-slate-800 rounded px-2 py-1" value="${p.count}">
                        </div>
                        <button data-action="remove-placed" data-instance-id="${p.instanceId}" class="px-2 py-1 bg-slate-800 rounded-lg hover:bg-slate-700 text-xs">Quitar</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderTrackerPanel() {
        const { tracker } = state;
        if (!tracker) return '';
        return `
            <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-3 h-full flex flex-col">
                <div class="flex items-center justify-between flex-shrink-0">
                    <div class="font-medium">Rastreador</div>
                    <div class="flex gap-2">
                         <button data-action="open-hero-modal" class="px-3 py-1.5 rounded-xl bg-blue-700 hover:bg-blue-600">Agregar Héroes</button>
                         <button data-action="end-encounter" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700">Terminar</button>
                    </div>
                </div>
                <div class="space-y-2 flex-grow overflow-auto custom-scrollbar pr-1">
                    ${tracker.order.map((id, idx) => renderUnitRow(tracker.units.find(u => u.unitId === id), idx === tracker.turnIndex)).join('')}
                </div>
            </div>
        `;
    }
    
    function renderInitiativePanel() {
        const { tracker, isInitiativeOpen } = state;
        if (!tracker) return '';
        return `
            <div class="rounded-2xl p-4 bg-slate-900 border border-slate-800 space-y-2 h-full flex flex-col">
                <div class="flex justify-between items-center">
                    <div class="font-medium ${!isInitiativeOpen ? 'hidden' : ''}">Iniciativa</div>
                    <button data-action="toggle-initiative" class="px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs">
                        ${isInitiativeOpen ? '>>' : '<<'}
                    </button>
                </div>
                <div class="flex-grow overflow-auto custom-scrollbar pr-2 ${!isInitiativeOpen ? 'hidden' : ''}">
                    ${tracker.order.map((id, idx) => {
                        const unit = tracker.units.find(u => u.unitId === id);
                        const isHero = unit.role === 'hero';
                        const isActive = idx === tracker.turnIndex;
                        return `
                        <div class="p-2 my-1 rounded-lg ${isHero ? 'bg-blue-900/50' : 'bg-slate-800'} ${isActive ? 'ring-2 ring-emerald-500' : ''} text-xs flex items-center justify-between gap-1">
                            <span class="truncate"><b>${idx + 1}.</b> ${unit?.name || id}</span>
                            <div class="flex-shrink-0">
                                <button data-action="move-initiative" data-idx="${idx}" data-dir="-1" class="px-1 rounded bg-slate-700 hover:bg-slate-600">↑</button>
                                <button data-action="move-initiative" data-idx="${idx}" data-dir="1" class="px-1 rounded bg-slate-700 hover:bg-slate-600">↓</button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>
        `;
    }

    function renderUnitRow(u, isActive) {
        if (!u) return '';
        const isHero = u.role === 'hero';
        const monster = isHero ? null : getMonsterById(u.monsterId);
        const hasManeuver = !isHero && monster?.abilities?.some(a => a.action === 'maneuver');
        const isDead = !isHero && u.hp <= 0;
        const isBlooded = !isHero && !isDead && u.hp <= u.hpMax * 0.25;
        const isSelected = state.selectedUnitId === u.unitId;
        const pct = isHero ? 100 : Math.max(0, Math.min(100, Math.round((u.hp / u.hpMax) * 100)));
        const bar = isHero ? 'bg-blue-500' : (pct >= 66 ? "bg-emerald-600" : pct >= 33 ? "bg-amber-500" : "bg-rose-600");
        const isOpen = state.openUnitCards[u.unitId];
        const activeTab = state.activeUnitTabs[u.unitId] || 'acciones';
        
        let borderColor = "border-slate-800";
        if (isActive && !isDead) borderColor = "border-emerald-500 shadow-lg shadow-emerald-500/20";
        else if (isSelected && !isDead) borderColor = "border-blue-500 shadow-lg shadow-blue-500/20";

        const tabButton = (tabName, label) => `<button data-action="set-unit-tab" data-unit-id="${u.unitId}" data-tab-name="${tabName}" class="px-3 py-1 text-xs rounded-t-lg ${activeTab === tabName ? 'bg-slate-800' : 'bg-slate-900'}">${label}</button>`;
        
        const conditionIcons = u.conditions.map(c => `<span class="text-xs bg-red-800 px-1.5 py-0.5 rounded-md" title="${CONDITIONS_MAP[c] || c}">${c.substring(0,3)}</span>`).join('');

        return `
            <div class="unit-card p-3 rounded-xl border ${borderColor} ${isDead ? 'opacity-50 bg-slate-950' : 'bg-slate-900/60'}">
                <div class="flex items-start justify-between">
                    <div class="flex-grow pr-4">
                        <div data-action="select-unit" data-unit-id="${u.unitId}" class="font-medium text-sm cursor-pointer flex items-center gap-2 ${isDead ? 'line-through' : ''}">
                            <span>${isHero ? `★ ${u.name}` : u.name}</span>
                            <span class="opacity-60 text-xs">${isHero ? u.label : `L${u.level} · ${u.org} · ${u.role}`}</span>
                            <div class="flex gap-1">${conditionIcons}</div>
                        </div>
                        ${!isHero ? `<div class="h-2 rounded bg-slate-800 mt-1 mb-1 overflow-hidden"><div class="h-2 ${bar}" style="width: ${pct}%"></div></div>` : '<div class="h-2"></div>'}
                        <div class="flex items-center gap-2">
                            <div class="text-xs opacity-80">
                                ${!isHero ? `HP ${u.hp}/${u.hpMax} · FS ${u.freeStrike}` : ''}
                                ${isBlooded ? `<span class="ml-2 text-rose-400 font-bold">Ensangrentado</span>` : ''}
                                ${isDead ? `<span class="ml-2 text-red-500 font-bold">Muerto</span>` : ''}
                            </div>
                            ${!isHero ? `<button data-action="toggle-unit-card" data-unit-id="${u.unitId}" class="text-xs font-bold bg-slate-700 hover:bg-slate-600 rounded-full w-5 h-5 flex items-center justify-center flex-shrink-0">${isOpen ? '−' : '+'}</button>` : ''}
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        ${!isHero ? `
                        <div class="flex items-center gap-2">
                            <input type="number" placeholder="Valor" class="w-20 bg-slate-800 rounded-lg px-2 py-1 text-xs" data-hp-input="${u.unitId}">
                            <button data-action="adjust-hp" data-unit-id="${u.unitId}" data-delta-sign="-1" class="px-2 py-1 bg-rose-800 hover:bg-rose-700 rounded-lg text-xs" ${isDead ? 'disabled' : ''}>Daño</button>
                            <button data-action="adjust-hp" data-unit-id="${u.unitId}" data-delta-sign="1" class="px-2 py-1 bg-emerald-800 hover:bg-emerald-700 rounded-lg text-xs">Sana</button>
                        </div>` : ''}
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-4 text-xs">
                    <label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="move" ${u.actionsUsed.move ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Movimiento</label>
                    <label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="attack" ${u.actionsUsed.attack ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Ataque</label>
                    ${hasManeuver ? `<label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="maneuver" ${u.actionsUsed.maneuver ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Maniobra</label>` : ''}
                    ${isHero ? `<label class="flex items-center gap-1.5"><input type="checkbox" data-action="toggle-action" data-unit-id="${u.unitId}" data-action-name="bonusAction" ${u.actionsUsed.bonusAction ? 'checked' : ''} ${isDead ? 'disabled' : ''}> Bonus Action</label>` : ''}
                </div>
                ${isOpen && monster ? `
                    <div class="mt-2 text-[11px]">
                        <div class="border-b border-slate-800">
                            ${tabButton('acciones', 'Acciones')}
                            ${tabButton('rasgos', 'Rasgos')}
                            ${tabButton('condiciones', 'Condiciones')}
                        </div>
                        <div class="p-2 bg-slate-800 rounded-b-lg">
                            ${activeTab === 'acciones' ? `<div class="space-y-2">${monster.abilities.map(a => renderAbilityBlock(a, true, u.unitId)).join('')}</div>` : ''}
                            ${activeTab === 'rasgos' ? `<div class="space-y-2">${monster.traits.map(t => `<div><b>${t.name}.</b> ${t.text}</div>`).join('')}</div>` : ''}
                            ${activeTab === 'condiciones' ? `<div class="flex flex-wrap gap-1 text-[10px]">${Object.keys(CONDITIONS_MAP).map(c => `<span data-action="toggle-condition" data-unit-id="${u.unitId}" data-cond="${c}" class="select-none px-2 py-1 rounded-full cursor-pointer ${u.conditions.includes(c) ? "bg-slate-200 text-slate-900" : "bg-slate-700 text-slate-200"}" title="${CONDITIONS_MAP[c]}">${c}</span>`).join('')}</div>` : ''}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    function renderHeroModal() {
        return `
            <div class="fixed inset-0 bg-black/70 flex items-center justify-center">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 w-full max-w-md space-y-4">
                    <h2 class="text-lg font-semibold">Agregar Héroes</h2>
                    <div id="hero-inputs" class="grid grid-cols-2 gap-4">
                        ${Array(8).fill(0).map((_, i) => `<input type="text" placeholder="Héroe ${i + 1}" class="bg-slate-800 rounded-lg px-3 py-2 text-sm w-full">`).join('')}
                    </div>
                    <div class="flex justify-end gap-4">
                        <button data-action="close-hero-modal" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">Cerrar</button>
                        <button data-action="add-heroes" class="px-4 py-2 rounded-xl bg-blue-700 hover:bg-blue-600">Agregar</button>
                    </div>
                </div>
            </div>
        `;
    }

    // --- EVENT LISTENERS & LOGIC ---
    function addEventListeners() {
        appContainer.addEventListener('click', handleAppClick);
        appContainer.addEventListener('input', handleAppInput);
        appContainer.addEventListener('change', handleAppChange);
        modalContainer.addEventListener('click', handleAppClick);
    }
    
    function handleAppClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const nonClickActions = ['toggle-action', 'set-placed-count'];
        if (nonClickActions.includes(target.dataset.action)) return;

        const { action, monsterId, instanceId, unitId, idx, dir, deltaSign, cond, tabName, abilityId } = target.dataset;
        let stateChanged = true;

        switch(action) {
            case 'toggle-library': state.isLibraryOpen = !state.isLibraryOpen; break;
            case 'toggle-initiative': state.isInitiativeOpen = !state.isInitiativeOpen; break;
            case 'reset-filters': state.filters = { keyword: 'all', organization: 'all', level: 'all', q: '' }; break;
            case 'toggle-monster-card': state.openMonsterCards[monsterId] = !state.openMonsterCards[monsterId]; break;
            case 'add-monster':
                const monster = getMonsterById(monsterId);
                state.builder.push({ instanceId: `${monsterId}:${cryptoRandom()}`, monsterId, count: monster?.minion ? (monster.minionPerSquad || 4) : 1 });
                break;
            case 'remove-placed': state.builder = state.builder.filter(p => p.instanceId !== instanceId); break;
            case 'start-encounter': handleStartEncounter(); break;
            case 'reset-builder': state.builder = []; break;
            case 'end-encounter': state.tracker = null; state.selectedUnitId = null; break;
            case 'advance-turn': handleAdvanceTurn(); break;
            case 'move-initiative': handleMoveInitiative(parseInt(idx, 10), parseInt(dir, 10)); break;
            case 'toggle-unit-card': state.openUnitCards[unitId] = !state.openUnitCards[unitId]; break;
            case 'set-unit-tab': state.activeUnitTabs[unitId] = tabName; break;
            case 'adjust-hp': handleAdjustHp(unitId, deltaSign); break;
            case 'toggle-condition': handleToggleCondition(unitId, cond); break;
            case 'use-ability': handleUseAbility(unitId, abilityId); break;
            case 'select-unit': state.selectedUnitId = state.selectedUnitId === unitId ? null : unitId; break;
            case 'open-hero-modal': state.isHeroModalOpen = true; break;
            case 'close-hero-modal': state.isHeroModalOpen = false; break;
            case 'add-heroes': handleAddHeroes(); break;
            default: stateChanged = false; break;
        }
        
        if (stateChanged) {
            saveState();
            render();
        }
    }

    function handleAppInput(e) {
        const target = e.target;
        if (target.id === 'search-input') {
            state.filters.q = target.value;
            render();
        } else if (target.dataset.partyField) {
            state.party[target.dataset.partyField] = target.value;
            saveState();
        } else if (target.dataset.action === 'set-placed-count') {
            const p = state.builder.find(p => p.instanceId === target.dataset.instanceId);
            if (p) p.count = Math.max(1, parseInt(target.value, 10) || 1);
            render();
        }
    }

    function handleAppChange(e) {
        const target = e.target;
        if (target.dataset.filter) {
            state.filters[target.dataset.filter] = target.value;
            render();
        } else if (target.dataset.action === 'toggle-action') {
            handleToggleAction(target.dataset.unitId, target.dataset.actionName, target.checked);
            saveState();
            render();
        }
    }
    
    // --- LOGIC FUNCTIONS ---
    function handleStartEncounter() {
        const units = [];
        state.builder.forEach(p => {
            const m = getMonsterById(p.monsterId);
            if (!m) return;
            const baseUnit = { level: m.level, role: m.role, org: m.organization, freeStrike: m.freeStrike, monsterId: m.id, conditions: [], actionsUsed: { move: false, attack: false, maneuver: false, bonusAction: false } };
            if (m.organization === "minion") {
                units.push({ ...baseUnit, unitId: `${p.instanceId}-squad`, name: `${m.name}`, label: "Squad", hp: m.stamina * p.count, hpMax: m.stamina * p.count });
            } else {
                for (let i = 1; i <= p.count; i++) {
                    units.push({ ...baseUnit, unitId: `${p.instanceId}-${i}`, name: `${m.name} #${i}`, label: "", hp: m.stamina, hpMax: m.stamina });
                }
            }
        });
        state.tracker = {
            started: true, round: 1, order: units.map(u => u.unitId), turnIndex: 0, units,
            malice: units.length, log: [{ t: Date.now(), msg: `Encounter started.` }]
        };
    }

    function handleAdvanceTurn() {
        if (!state.tracker) return;
        const t = state.tracker;
        t.turnIndex = (t.turnIndex + 1) % t.order.length;
        if (t.turnIndex === 0) t.round++;
        const nextUnitId = t.order[t.turnIndex];
        const nextUnit = t.units.find(u => u.unitId === nextUnitId);
        if (nextUnit) nextUnit.actionsUsed = { move: false, attack: false, maneuver: false, bonusAction: false };
    }

    function handleMoveInitiative(idx, dir) {
        const { order } = state.tracker;
        const j = idx + dir;
        if (j < 0 || j >= order.length) return;
        [order[idx], order[j]] = [order[j], order[idx]];
    }

    function handleAdjustHp(unitId, deltaSign) {
        const input = document.querySelector(`[data-hp-input="${unitId}"]`);
        const value = parseInt(input.value, 10);
        if (isNaN(value) || value <= 0) return;
        
        const delta = value * parseInt(deltaSign, 10);
        const unit = state.tracker.units.find(u => u.unitId === unitId);
        const oldHp = unit.hp;
        unit.hp = Math.max(0, unit.hp + delta);
        if (oldHp > 0 && unit.hp === 0) {
            state.tracker.malice++;
        }
        input.value = '';
    }

    function handleToggleAction(unitId, actionName, isChecked) {
        const unit = state.tracker.units.find(u => u.unitId === unitId);
        if (!unit) return;

        unit.actionsUsed[actionName] = isChecked;

        const monster = getMonsterById(unit.monsterId);
        const isHero = unit.role === 'hero';
        const hasManeuver = !isHero && monster?.abilities?.some(a => a.action === 'maneuver');
        
        let allActionsUsed = false;
        if (isHero) {
            allActionsUsed = unit.actionsUsed.move && unit.actionsUsed.attack && unit.actionsUsed.bonusAction;
        } else {
            allActionsUsed = unit.actionsUsed.move && unit.actionsUsed.attack && (!hasManeuver || unit.actionsUsed.maneuver);
        }

        if (allActionsUsed) {
            setTimeout(() => {
                handleAdvanceTurn();
                saveState();
                render();
            }, 300); // Small delay to see the checkmark
        }
    }

    function handleToggleCondition(unitId, cond) {
        const unit = state.tracker.units.find(u => u.unitId === unitId);
        if (unit) unit.conditions = toggleInArray(unit.conditions, cond);
    }
    
    function handleUseAbility(unitId, abilityId) {
        const unit = state.tracker.units.find(u => u.unitId === unitId);
        if (!unit) return;
        const monster = getMonsterById(unit.monsterId);
        const ability = monster.abilities.find(a => a.id === abilityId);
        if (!ability || (ability.malice && state.tracker.malice < ability.malice)) return;

        if (ability.malice) state.tracker.malice -= ability.malice;
        if (ability.action === 'main') unit.actionsUsed.attack = true;
        if (ability.action === 'maneuver') unit.actionsUsed.maneuver = true;

        const hasManeuver = monster?.abilities?.some(a => a.action === 'maneuver');
        const allActionsUsed = unit.actionsUsed.move && unit.actionsUsed.attack && (!hasManeuver || unit.actionsUsed.maneuver);

        if (allActionsUsed) {
             setTimeout(() => {
                handleAdvanceTurn();
                saveState();
                render();
            }, 300);
        }
    }
    
    function handleAddHeroes() {
        const inputs = document.querySelectorAll('#hero-inputs input');
        const names = Array.from(inputs).map(input => input.value.trim()).filter(name => name);
        if (names.length === 0) {
            state.isHeroModalOpen = false;
            return;
        }

        const t = state.tracker;
        if (!t) return;

        names.forEach(name => {
            const unitId = `hero-${cryptoRandom()}`;
            const hero = {
                unitId, name, label: "Héroe", level: "—", role: "hero", org: "hero",
                monsterId: null, freeStrike: "—", hp: 0, hpMax: 0,
                actionsUsed: { move: false, attack: false, maneuver: false, bonusAction: false },
                conditions: []
            };
            t.units.push(hero);
            t.order.push(unitId);
        });
        
        state.isHeroModalOpen = false;
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        initState();
        render();
    });
    </script>
</body>
</html>
